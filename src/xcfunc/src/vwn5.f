!--------------------------------------------------------------------------
!                 Reference section for the functional:
!--------------------------------------------------------------------------
! S. H. Vosko, L. Wilk, and M. Nusair, 
! “Accurate spin-dependent electron liquid correlation 
!  energies for local spin density calculations: 
!  A critical analysis,”  the 5th functional
! Can. J. Phys., 58 (1980) 1200-11.
!
!



      subroutine functional_vwn5
     &(INFOR,NG,NDEN,TOL,rhoA,rhoB,F,D1F)
      IMPLICIT NONE
!--------------------------------------------------------
! This routine is used to calculate the functional and
! functional derivatives values up to the third order.
! It's only the interface function, the real calculation
! work will be done by seperate routine.
! INPUT :
! INFOR : information related to the variables
! NG    : the number of grid points
! NDEN  : the number of densities
! TOL   : tolerance value for error
! rhoA  : the alpha electron density
! rhoB  : the beta  electron density
! DRhoA : the alpha rho'
! DRhoB : the beta  rho'
! TauA  : the alpha kinetic energy density
! TauB  : the beta  kinetic energy density
! LapA  : the alpha laplacian density
! LapB  : the beta  laplacian density
! OUTPUT:
! F     : functional values
! D1F   : the first  order functional derivatives
! D2F   : the second order functional derivatives
! D3F   : the third  order functional derivatives
!--------------------------------------------------------
      INTEGER INFOR(*)
      INTEGER NG,NDEN
      DOUBLE PRECISION TOL
      DOUBLE PRECISION rhoA(NG),rhoB(NG)
      DOUBLE PRECISION F(NG), D1F(NG,*)
      
      IF (NDEN .EQ. 1) THEN 
      CALL functional_vwn5_close
     &(INFOR,NG,NDEN,TOL,rhoA,F,D1F)
      ELSE  
      CALL functional_vwn5_open
     &(INFOR,NG,NDEN,TOL,rhoA,rhoB,F,D1F)
      END IF  
      RETURN  
      END     



      subroutine functional_vwn5_close
     &(INFOR,NG,NDEN,TOL,rhoA,F,D1F)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
!--------------------------------------------------------
! This routine is used to calculate the functional and
! functional derivatives values up to the third order.
! We note that this routine is used in the close shell case,
! that means, we have RA=RB, GAA=GAB=GBB,TA=TB and LA=LB
! for each grid point.
!--------------------------------------------------------
#include "fderiv1.inc"
      INTEGER INFOR(*)
      INTEGER IDERIV, NG
      DOUBLE PRECISION rhoA(NG)
      DOUBLE PRECISION RA, RB ! rho vaule at each point
      DOUBLE PRECISION F(NG),D1F(NG,*)
      DOUBLE PRECISION TOL ! tolerance
      DOUBLE PRECISION PI
      INTEGER  D1VARS(N_FUNC_DERIV_1)
      
      ! firstly initilize variable position information
      CALL INIT_FUNC_DERIV_1(INFOR,D1VARS)
      
      ! deal with the constants
      PI    = 4.D0*DATAN(1.D0)
      IDERIV    = 1

      ! the real calculation begins
      DO i = 1,NG
      RA = rhoA(i)
      RB = RA 
      IF (RA.LE.TOL) CYCLE
      t1 = RA+RB
      t2 = 1/t1
      t3 = t2**(1.D0/3.D0)
      t4 = t2**(1.D0/6.D0)
      t6 = 0.6203504908994D0*t3
      t8 = 1/(0.2935818660072219D1*t4+t6+0.129352D2)
      t11 = dlog(0.6203504908994D0*t3*t8)
      t12 = 0.310907D-1*t11
      t13 = 0.1575246635799487D1*t4
      t17 = datan(0.615199082D1/(t13+0.372744D1))
      t18 = 0.3878329488D-1*t17
      t19 = 0.7876233178997433D0*t4
      t21 = (t19+0.10498D0)**2
      t23 = dlog(t21*t8)
      t24 = 0.9690227711D-3*t23
      t27 = 1/(0.8908571061768626D0*t4+t6+0.130045D2)
      t30 = dlog(0.6203504908994D0*t3*t27)
      t34 = datan(0.7123108918D1/(t13+0.113107D1))
      t37 = (t19+0.47584D-2)**2
      t39 = dlog(t37*t27)
      t41 = t30+0.3177080047D0*t34+0.4140337942D-3*t39
      t43 = RA-1.D0*RB
      t44 = t43*t2
      t45 = 1.D0+t44
      t46 = t45**(1.D0/3.D0)
      t50 = 1.D0-1.D0*t44
      t51 = t50**(1.D0/3.D0)
      t58 = 1/(0.5560951426165705D1*t4+t6+0.180578D2)
      t61 = dlog(0.6203504908994D0*t3*t58)
      t66 = datan(0.4730926909D1/(t13+0.706042D1))
      t69 = (t19+0.325D0)**2
      t71 = dlog(t69*t58)
      t78 = t43**2
      t79 = t78**2
      t81 = t1**2
      t82 = t81**2
      t89 = t1*(t12+t18+t24-0.1688686394038963D-1*t41*(0.1125D1*t46*t45+
     &0.1125D1*t51*t50-0.225D1)*(1.D0+(-0.101257459063883D3*(0.1554535D-
     &1*t61+0.5249139317D-1*t66+0.2247867096D-2*t71-t12-t18-t24)/t41-1.D
     &0)*t79/t82))
      F(i) = F(i) +      t89 
      IF (IDERIV .GE. 1) THEN
      t1 = RA+RB
      t2 = 1/t1
      t3 = t2**(1.D0/3.D0)
      t4 = t2**(1.D0/6.D0)
      t6 = 0.6203504908994D0*t3
      t7 = 0.2935818660072219D1*t4+t6+0.129352D2
      t8 = 1/t7
      t11 = dlog(0.6203504908994D0*t3*t8)
      t12 = 0.310907D-1*t11
      t13 = 0.1575246635799487D1*t4
      t14 = t13+0.372744D1
      t17 = datan(0.615199082D1/t14)
      t18 = 0.3878329488D-1*t17
      t19 = 0.7876233178997433D0*t4
      t20 = t19+0.10498D0
      t21 = t20**2
      t23 = dlog(t21*t8)
      t24 = 0.9690227711D-3*t23
      t26 = 0.8908571061768626D0*t4+t6+0.130045D2
      t27 = 1/t26
      t30 = dlog(0.6203504908994D0*t3*t27)
      t31 = t13+0.113107D1
      t34 = datan(0.7123108918D1/t31)
      t36 = t19+0.47584D-2
      t37 = t36**2
      t39 = dlog(t37*t27)
      t41 = t30+0.3177080047D0*t34+0.4140337942D-3*t39
      t43 = RA-1.D0*RB
      t44 = t43*t2
      t45 = 1.D0+t44
      t46 = t45**(1.D0/3.D0)
      t50 = 1.D0-1.D0*t44
      t51 = t50**(1.D0/3.D0)
      t54 = 0.1125D1*t46*t45+0.1125D1*t51*t50-0.225D1
      t55 = t41*t54
      t57 = 0.5560951426165705D1*t4+t6+0.180578D2
      t58 = 1/t57
      t61 = dlog(0.6203504908994D0*t3*t58)
      t63 = t13+0.706042D1
      t66 = datan(0.4730926909D1/t63)
      t68 = t19+0.325D0
      t69 = t68**2
      t71 = dlog(t69*t58)
      t73 = 0.1554535D-1*t61+0.5249139317D-1*t66+0.2247867096D-2*t71-t12
     &-t18-t24
      t74 = 1/t41
      t77 = -0.101257459063883D3*t73*t74-1.D0
      t78 = t43**2
      t79 = t78**2
      t80 = t77*t79
      t81 = t1**2
      t82 = t81**2
      t83 = 1/t82
      t85 = 1.D0+t80*t83
      t88 = t3**2
      t89 = 1/t88
      t91 = 1/t81
      t94 = t7**2
      t95 = 1/t94
      t97 = t4**2
      t98 = t97**2
      t100 = 1/t98/t4
      t101 = t100*t91
      t104 = 0.2067834969664667D0*t89*t91
      t105 = -0.4893031100120365D0*t101-t104
      t109 = 1/t3
      t111 = (-0.2067834969664667D0*t89*t8*t91-0.6203504908994D0*t3*t95*
     &t105)*t109*t7
      t113 = t14**2
      t114 = 1/t113
      t120 = t114*t100*t91/(1.D0+0.3784699104936427D2*t114)
      t132 = 0.9690227711D-3*(-0.2625411059665811D0*t20*t8*t101-1.D0*t21
     &*t95*t105)/t21*t7
      t136 = t26**2
      t137 = 1/t136
      t140 = -0.1484761843628104D0*t101-t104
      t147 = t31**2
      t148 = 1/t147
      t167 = 0.161199195401647D1*(-0.2067834969664667D0*t89*t27*t91-0.62
     &03504908994D0*t3*t137*t140)*t109*t26+0.5941485650468617D0*t148*t10
     &0*t91/(1.D0+0.5073868065769113D2*t148)+0.4140337942D-3*(-0.2625411
     &059665811D0*t36*t27*t101-1.D0*t37*t137*t140)/t37*t26
      t171 = t43*t91
      t187 = t57**2
      t188 = 1/t187
      t191 = -0.9268252376942842D0*t101-t104
      t198 = t63**2
      t199 = 1/t198
      t223 = t41**2
      t244 = t12+t18+t24-0.1688686394038963D-1*t55*t85+t1*(0.50117958244
     &73985D-1*t111+0.6264085710014476D-1*t120+t132-0.1688686394038963D-
     &1*t167*t54*t85-0.1688686394038963D-1*t41*(0.15D1*t46*(t2-1.D0*t171
     &)+0.15D1*t51*(-1.D0*t2+t171))*t85-0.1688686394038963D-1*t55*((-0.1
     &01257459063883D3*(0.2505897912236993D-1*(-0.2067834969664667D0*t89
     &*t58*t91-0.6203504908994D0*t3*t188*t191)*t109*t57+0.65197605880913
     &69D-1*t199*t100*t91/(1.D0+0.2238166941830029D2*t199)+0.2247867096D
     &-2*(-0.2625411059665811D0*t68*t58*t101-1.D0*t69*t188*t191)/t69*t57
     &-0.5011795824473985D-1*t111-0.6264085710014476D-1*t120-t132)*t74+0
     &.101257459063883D3*t73/t223*t167)*t79*t83+4.D0*t77*t78*t43*t83-4.D
     &0*t80/t82/t1))
      ID_RA_POS=D1VARS(ID_RA)
      D1F(i, ID_RA_POS) = D1F(i, ID_RA_POS) +      t244 
      END IF
      IF (IDERIV .GE. 1) THEN
      ID_RB_POS=D1VARS(ID_RB)
      D1F(i, ID_RB_POS)= D1F(i, ID_RA_POS)
      END IF
      END DO
      RETURN
      END
                   
                   
                   
                   
      subroutine functional_vwn5_open
     &(INFOR,NG,NDEN,TOL,rhoA,rhoB,F,D1F)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
!--------------------------------------------------------
! This routine is used to calculate the functional and
! functional derivatives values up to the third order.
! We note that this routine is used in the open shell case.
!--------------------------------------------------------
#include "fderiv1.inc"
      INTEGER INFOR(*)
      INTEGER IDERIV, NG
      DOUBLE PRECISION rhoA(NG)
      DOUBLE PRECISION RA, RB ! rho vaule at each point
      DOUBLE PRECISION rhoB(NG)
      DOUBLE PRECISION DRhoB(NG,3),TauB(NG),LapB(NG)
      DOUBLE PRECISION F(NG),D1F(NG,*)
      DOUBLE PRECISION TOL ! tolerance
      DOUBLE PRECISION PI
      INTEGER  D1VARS(N_FUNC_DERIV_1)
      
      ! firstly initilize variable position information
      CALL INIT_FUNC_DERIV_1(INFOR,D1VARS)
      
      ! deal with the constants
      PI    = 4.D0*DATAN(1.D0)
      IDERIV    = 1

      ! the real calculation begins
      DO i = 1,NG
         RA = rhoA(i)
         RB = rhoB(i)
      IF (RB.LE.TOL) THEN
         RB = 0.0D0 
      END IF 
      IF (RA.LE.TOL) THEN
         RA = 0.0D0 
      END IF 
      IF (RA.LE.TOL .AND. RB.LE.TOL) THEN
         CYCLE 
      END IF 
             
      IF (RA.GT.TOL .AND. RB.GT.TOL) THEN
      t1 = RA+RB
      t2 = 1/t1
      t3 = t2**(1.D0/3.D0)
      t4 = t2**(1.D0/6.D0)
      t6 = 0.6203504908994D0*t3
      t8 = 1/(0.2935818660072219D1*t4+t6+0.129352D2)
      t11 = dlog(0.6203504908994D0*t3*t8)
      t12 = 0.310907D-1*t11
      t13 = 0.1575246635799487D1*t4
      t17 = datan(0.615199082D1/(t13+0.372744D1))
      t18 = 0.3878329488D-1*t17
      t19 = 0.7876233178997433D0*t4
      t21 = (t19+0.10498D0)**2
      t23 = dlog(t21*t8)
      t24 = 0.9690227711D-3*t23
      t27 = 1/(0.8908571061768626D0*t4+t6+0.130045D2)
      t30 = dlog(0.6203504908994D0*t3*t27)
      t34 = datan(0.7123108918D1/(t13+0.113107D1))
      t37 = (t19+0.47584D-2)**2
      t39 = dlog(t37*t27)
      t41 = t30+0.3177080047D0*t34+0.4140337942D-3*t39
      t43 = RA-1.D0*RB
      t44 = t43*t2
      t45 = 1.D0+t44
      t46 = t45**(1.D0/3.D0)
      t50 = 1.D0-1.D0*t44
      t51 = t50**(1.D0/3.D0)
      t58 = 1/(0.5560951426165705D1*t4+t6+0.180578D2)
      t61 = dlog(0.6203504908994D0*t3*t58)
      t66 = datan(0.4730926909D1/(t13+0.706042D1))
      t69 = (t19+0.325D0)**2
      t71 = dlog(t69*t58)
      t78 = t43**2
      t79 = t78**2
      t81 = t1**2
      t82 = t81**2
      t89 = t1*(t12+t18+t24-0.1688686394038963D-1*t41*(0.1125D1*t46*t45+
     &0.1125D1*t51*t50-0.225D1)*(1.D0+(-0.101257459063883D3*(0.1554535D-
     &1*t61+0.5249139317D-1*t66+0.2247867096D-2*t71-t12-t18-t24)/t41-1.D
     &0)*t79/t82))
      F(i) = F(i) +      t89 
      IF (IDERIV .GE. 1) THEN
      t1 = RA+RB
      t2 = 1/t1
      t3 = t2**(1.D0/3.D0)
      t4 = t2**(1.D0/6.D0)
      t6 = 0.6203504908994D0*t3
      t7 = 0.2935818660072219D1*t4+t6+0.129352D2
      t8 = 1/t7
      t11 = dlog(0.6203504908994D0*t3*t8)
      t12 = 0.310907D-1*t11
      t13 = 0.1575246635799487D1*t4
      t14 = t13+0.372744D1
      t17 = datan(0.615199082D1/t14)
      t18 = 0.3878329488D-1*t17
      t19 = 0.7876233178997433D0*t4
      t20 = t19+0.10498D0
      t21 = t20**2
      t23 = dlog(t21*t8)
      t24 = 0.9690227711D-3*t23
      t26 = 0.8908571061768626D0*t4+t6+0.130045D2
      t27 = 1/t26
      t30 = dlog(0.6203504908994D0*t3*t27)
      t31 = t13+0.113107D1
      t34 = datan(0.7123108918D1/t31)
      t36 = t19+0.47584D-2
      t37 = t36**2
      t39 = dlog(t37*t27)
      t41 = t30+0.3177080047D0*t34+0.4140337942D-3*t39
      t43 = RA-1.D0*RB
      t44 = t43*t2
      t45 = 1.D0+t44
      t46 = t45**(1.D0/3.D0)
      t50 = 1.D0-1.D0*t44
      t51 = t50**(1.D0/3.D0)
      t54 = 0.1125D1*t46*t45+0.1125D1*t51*t50-0.225D1
      t55 = t41*t54
      t57 = 0.5560951426165705D1*t4+t6+0.180578D2
      t58 = 1/t57
      t61 = dlog(0.6203504908994D0*t3*t58)
      t63 = t13+0.706042D1
      t66 = datan(0.4730926909D1/t63)
      t68 = t19+0.325D0
      t69 = t68**2
      t71 = dlog(t69*t58)
      t73 = 0.1554535D-1*t61+0.5249139317D-1*t66+0.2247867096D-2*t71-t12
     &-t18-t24
      t74 = 1/t41
      t77 = -0.101257459063883D3*t73*t74-1.D0
      t78 = t43**2
      t79 = t78**2
      t80 = t77*t79
      t81 = t1**2
      t82 = t81**2
      t83 = 1/t82
      t85 = 1.D0+t80*t83
      t88 = t3**2
      t89 = 1/t88
      t91 = 1/t81
      t94 = t7**2
      t95 = 1/t94
      t97 = t4**2
      t98 = t97**2
      t100 = 1/t98/t4
      t101 = t100*t91
      t104 = 0.2067834969664667D0*t89*t91
      t105 = -0.4893031100120365D0*t101-t104
      t109 = 1/t3
      t111 = (-0.2067834969664667D0*t89*t8*t91-0.6203504908994D0*t3*t95*
     &t105)*t109*t7
      t113 = t14**2
      t114 = 1/t113
      t120 = t114*t100*t91/(1.D0+0.3784699104936427D2*t114)
      t132 = 0.9690227711D-3*(-0.2625411059665811D0*t20*t8*t101-1.D0*t21
     &*t95*t105)/t21*t7
      t136 = t26**2
      t137 = 1/t136
      t140 = -0.1484761843628104D0*t101-t104
      t147 = t31**2
      t148 = 1/t147
      t167 = 0.161199195401647D1*(-0.2067834969664667D0*t89*t27*t91-0.62
     &03504908994D0*t3*t137*t140)*t109*t26+0.5941485650468617D0*t148*t10
     &0*t91/(1.D0+0.5073868065769113D2*t148)+0.4140337942D-3*(-0.2625411
     &059665811D0*t36*t27*t101-1.D0*t37*t137*t140)/t37*t26
      t171 = t43*t91
      t187 = t57**2
      t188 = 1/t187
      t191 = -0.9268252376942842D0*t101-t104
      t198 = t63**2
      t199 = 1/t198
      t223 = t41**2
      t244 = t12+t18+t24-0.1688686394038963D-1*t55*t85+t1*(0.50117958244
     &73985D-1*t111+0.6264085710014476D-1*t120+t132-0.1688686394038963D-
     &1*t167*t54*t85-0.1688686394038963D-1*t41*(0.15D1*t46*(t2-1.D0*t171
     &)+0.15D1*t51*(-1.D0*t2+t171))*t85-0.1688686394038963D-1*t55*((-0.1
     &01257459063883D3*(0.2505897912236993D-1*(-0.2067834969664667D0*t89
     &*t58*t91-0.6203504908994D0*t3*t188*t191)*t109*t57+0.65197605880913
     &69D-1*t199*t100*t91/(1.D0+0.2238166941830029D2*t199)+0.2247867096D
     &-2*(-0.2625411059665811D0*t68*t58*t101-1.D0*t69*t188*t191)/t69*t57
     &-0.5011795824473985D-1*t111-0.6264085710014476D-1*t120-t132)*t74+0
     &.101257459063883D3*t73/t223*t167)*t79*t83+4.D0*t77*t78*t43*t83-4.D
     &0*t80/t82/t1))
      ID_RA_POS=D1VARS(ID_RA)
      D1F(i, ID_RA_POS) = D1F(i, ID_RA_POS) +      t244 
      t1 = RA+RB
      t2 = 1/t1
      t3 = t2**(1.D0/3.D0)
      t4 = t2**(1.D0/6.D0)
      t6 = 0.6203504908994D0*t3
      t7 = 0.2935818660072219D1*t4+t6+0.129352D2
      t8 = 1/t7
      t11 = dlog(0.6203504908994D0*t3*t8)
      t12 = 0.310907D-1*t11
      t13 = 0.1575246635799487D1*t4
      t14 = t13+0.372744D1
      t17 = datan(0.615199082D1/t14)
      t18 = 0.3878329488D-1*t17
      t19 = 0.7876233178997433D0*t4
      t20 = t19+0.10498D0
      t21 = t20**2
      t23 = dlog(t21*t8)
      t24 = 0.9690227711D-3*t23
      t26 = 0.8908571061768626D0*t4+t6+0.130045D2
      t27 = 1/t26
      t30 = dlog(0.6203504908994D0*t3*t27)
      t31 = t13+0.113107D1
      t34 = datan(0.7123108918D1/t31)
      t36 = t19+0.47584D-2
      t37 = t36**2
      t39 = dlog(t37*t27)
      t41 = t30+0.3177080047D0*t34+0.4140337942D-3*t39
      t43 = RA-1.D0*RB
      t44 = t43*t2
      t45 = 1.D0+t44
      t46 = t45**(1.D0/3.D0)
      t50 = 1.D0-1.D0*t44
      t51 = t50**(1.D0/3.D0)
      t54 = 0.1125D1*t46*t45+0.1125D1*t51*t50-0.225D1
      t55 = t41*t54
      t57 = 0.5560951426165705D1*t4+t6+0.180578D2
      t58 = 1/t57
      t61 = dlog(0.6203504908994D0*t3*t58)
      t63 = t13+0.706042D1
      t66 = datan(0.4730926909D1/t63)
      t68 = t19+0.325D0
      t69 = t68**2
      t71 = dlog(t69*t58)
      t73 = 0.1554535D-1*t61+0.5249139317D-1*t66+0.2247867096D-2*t71-t12
     &-t18-t24
      t74 = 1/t41
      t77 = -0.101257459063883D3*t73*t74-1.D0
      t78 = t43**2
      t79 = t78**2
      t80 = t77*t79
      t81 = t1**2
      t82 = t81**2
      t83 = 1/t82
      t85 = 1.D0+t80*t83
      t88 = t3**2
      t89 = 1/t88
      t91 = 1/t81
      t94 = t7**2
      t95 = 1/t94
      t97 = t4**2
      t98 = t97**2
      t100 = 1/t98/t4
      t101 = t100*t91
      t104 = 0.2067834969664667D0*t89*t91
      t105 = -0.4893031100120365D0*t101-t104
      t109 = 1/t3
      t111 = (-0.2067834969664667D0*t89*t8*t91-0.6203504908994D0*t3*t95*
     &t105)*t109*t7
      t113 = t14**2
      t114 = 1/t113
      t120 = t114*t100*t91/(1.D0+0.3784699104936427D2*t114)
      t132 = 0.9690227711D-3*(-0.2625411059665811D0*t20*t8*t101-1.D0*t21
     &*t95*t105)/t21*t7
      t136 = t26**2
      t137 = 1/t136
      t140 = -0.1484761843628104D0*t101-t104
      t147 = t31**2
      t148 = 1/t147
      t167 = 0.161199195401647D1*(-0.2067834969664667D0*t89*t27*t91-0.62
     &03504908994D0*t3*t137*t140)*t109*t26+0.5941485650468617D0*t148*t10
     &0*t91/(1.D0+0.5073868065769113D2*t148)+0.4140337942D-3*(-0.2625411
     &059665811D0*t36*t27*t101-1.D0*t37*t137*t140)/t37*t26
      t172 = t43*t91
      t187 = t57**2
      t188 = 1/t187
      t191 = -0.9268252376942842D0*t101-t104
      t198 = t63**2
      t199 = 1/t198
      t223 = t41**2
      t244 = t12+t18+t24-0.1688686394038963D-1*t55*t85+t1*(0.50117958244
     &73985D-1*t111+0.6264085710014476D-1*t120+t132-0.1688686394038963D-
     &1*t167*t54*t85-0.1688686394038963D-1*t41*(0.15D1*t46*(-1.D0*t2-1.D
     &0*t172)+0.15D1*t51*(t2+t172))*t85-0.1688686394038963D-1*t55*((-0.1
     &01257459063883D3*(0.2505897912236993D-1*(-0.2067834969664667D0*t89
     &*t58*t91-0.6203504908994D0*t3*t188*t191)*t109*t57+0.65197605880913
     &69D-1*t199*t100*t91/(1.D0+0.2238166941830029D2*t199)+0.2247867096D
     &-2*(-0.2625411059665811D0*t68*t58*t101-1.D0*t69*t188*t191)/t69*t57
     &-0.5011795824473985D-1*t111-0.6264085710014476D-1*t120-t132)*t74+0
     &.101257459063883D3*t73/t223*t167)*t79*t83-4.D0*t77*t78*t43*t83-4.D
     &0*t80/t82/t1))
      ID_RB_POS=D1VARS(ID_RB)
      D1F(i, ID_RB_POS) = D1F(i, ID_RB_POS) +      t244 
      END IF
      ELSE IF (RA.GT.TOL .AND. RB.LE.TOL) THEN
      t1 = 1/RA
      t2 = t1**(1.D0/3.D0)
      t3 = t1**(1.D0/6.D0)
      t5 = 0.6203504908994D0*t2
      t7 = 1/(0.2935818660072219D1*t3+t5+0.129352D2)
      t10 = dlog(0.6203504908994D0*t2*t7)
      t12 = 0.1575246635799487D1*t3
      t16 = datan(0.615199082D1/(t12+0.372744D1))
      t18 = 0.7876233178997433D0*t3
      t20 = (t18+0.10498D0)**2
      t22 = dlog(t20*t7)
      t26 = 1/(0.5560951426165705D1*t3+t5+0.180578D2)
      t29 = dlog(0.6203504908994D0*t2*t26)
      t34 = datan(0.4730926909D1/(t12+0.706042D1))
      t37 = (t18+0.325D0)**2
      t39 = dlog(t37*t26)
      t42 = RA*(-0.2D-21*t10-0.3D-21*t16-0.8D-23*t22+0.1554535D-1*t29+0.
     &5249139317D-1*t34+0.2247867096D-2*t39)
      F(i) = F(i) +      t42 
      IF (IDERIV .GE. 1) THEN
      t1 = 1/RA
      t2 = t1**(1.D0/3.D0)
      t3 = t1**(1.D0/6.D0)
      t5 = 0.6203504908994D0*t2
      t6 = 0.2935818660072219D1*t3+t5+0.129352D2
      t7 = 1/t6
      t10 = dlog(0.6203504908994D0*t2*t7)
      t12 = 0.1575246635799487D1*t3
      t13 = t12+0.372744D1
      t16 = datan(0.615199082D1/t13)
      t18 = 0.7876233178997433D0*t3
      t19 = t18+0.10498D0
      t20 = t19**2
      t22 = dlog(t20*t7)
      t25 = 0.5560951426165705D1*t3+t5+0.180578D2
      t26 = 1/t25
      t29 = dlog(0.6203504908994D0*t2*t26)
      t31 = t12+0.706042D1
      t34 = datan(0.4730926909D1/t31)
      t36 = t18+0.325D0
      t37 = t36**2
      t39 = dlog(t37*t26)
      t41 = t2**2
      t42 = 1/t41
      t44 = RA**2
      t45 = 1/t44
      t48 = t6**2
      t49 = 1/t48
      t51 = t3**2
      t52 = t51**2
      t54 = 1/t52/t3
      t55 = t54*t45
      t58 = 0.2067834969664667D0*t42*t45
      t59 = -0.4893031100120365D0*t55-t58
      t63 = 1/t2
      t67 = t13**2
      t68 = 1/t67
      t90 = t25**2
      t91 = 1/t90
      t94 = -0.9268252376942842D0*t55-t58
      t101 = t31**2
      t102 = 1/t101
      t123 = -0.2D-21*t10-0.3D-21*t16-0.8D-23*t22+0.1554535D-1*t29+0.524
     &9139317D-1*t34+0.2247867096D-2*t39+RA*(-0.5D-21*(-0.20678349696646
     &67D0*t42*t7*t45-0.6203504908994D0*t2*t49*t59)*t63*t6-0.5D-21*t68*t
     &54*t45/(1.D0+0.3784699104936427D2*t68)-0.8D-23*(-0.262541105966581
     &1D0*t19*t7*t55-1.D0*t20*t49*t59)/t20*t6+0.2505897912236993D-1*(-0.
     &2067834969664667D0*t42*t26*t45-0.6203504908994D0*t2*t91*t94)*t63*t
     &25+0.6519760588091369D-1*t102*t54*t45/(1.D0+0.2238166941830029D2*t
     &102)+0.2247867096D-2*(-0.2625411059665811D0*t36*t26*t55-1.D0*t37*t
     &91*t94)/t37*t25)
      ID_RA_POS=D1VARS(ID_RA)
      D1F(i, ID_RA_POS) = D1F(i, ID_RA_POS) +      t123 
      END IF
      ELSE IF (RA.LE.TOL .AND. RB.GT.TOL) THEN
      t1 = 1/RB
      t2 = t1**(1.D0/3.D0)
      t3 = t1**(1.D0/6.D0)
      t5 = 0.6203504908994D0*t2
      t7 = 1/(0.2935818660072219D1*t3+t5+0.129352D2)
      t10 = dlog(0.6203504908994D0*t2*t7)
      t12 = 0.1575246635799487D1*t3
      t16 = datan(0.615199082D1/(t12+0.372744D1))
      t18 = 0.7876233178997433D0*t3
      t20 = (t18+0.10498D0)**2
      t22 = dlog(t20*t7)
      t26 = 1/(0.5560951426165705D1*t3+t5+0.180578D2)
      t29 = dlog(0.6203504908994D0*t2*t26)
      t34 = datan(0.4730926909D1/(t12+0.706042D1))
      t37 = (t18+0.325D0)**2
      t39 = dlog(t37*t26)
      t42 = RB*(-0.2D-21*t10-0.3D-21*t16-0.8D-23*t22+0.1554535D-1*t29+0.
     &5249139317D-1*t34+0.2247867096D-2*t39)
      F(i) = F(i) +      t42 
      IF (IDERIV .GE. 1) THEN
      t1 = 1/RB
      t2 = t1**(1.D0/3.D0)
      t3 = t1**(1.D0/6.D0)
      t5 = 0.6203504908994D0*t2
      t6 = 0.2935818660072219D1*t3+t5+0.129352D2
      t7 = 1/t6
      t10 = dlog(0.6203504908994D0*t2*t7)
      t12 = 0.1575246635799487D1*t3
      t13 = t12+0.372744D1
      t16 = datan(0.615199082D1/t13)
      t18 = 0.7876233178997433D0*t3
      t19 = t18+0.10498D0
      t20 = t19**2
      t22 = dlog(t20*t7)
      t25 = 0.5560951426165705D1*t3+t5+0.180578D2
      t26 = 1/t25
      t29 = dlog(0.6203504908994D0*t2*t26)
      t31 = t12+0.706042D1
      t34 = datan(0.4730926909D1/t31)
      t36 = t18+0.325D0
      t37 = t36**2
      t39 = dlog(t37*t26)
      t41 = t2**2
      t42 = 1/t41
      t44 = RB**2
      t45 = 1/t44
      t48 = t6**2
      t49 = 1/t48
      t51 = t3**2
      t52 = t51**2
      t54 = 1/t52/t3
      t55 = t54*t45
      t58 = 0.2067834969664667D0*t42*t45
      t59 = -0.4893031100120365D0*t55-t58
      t63 = 1/t2
      t67 = t13**2
      t68 = 1/t67
      t90 = t25**2
      t91 = 1/t90
      t94 = -0.9268252376942842D0*t55-t58
      t101 = t31**2
      t102 = 1/t101
      t123 = -0.2D-21*t10-0.3D-21*t16-0.8D-23*t22+0.1554535D-1*t29+0.524
     &9139317D-1*t34+0.2247867096D-2*t39+RB*(-0.5D-21*(-0.20678349696646
     &67D0*t42*t7*t45-0.6203504908994D0*t2*t49*t59)*t63*t6-0.5D-21*t68*t
     &54*t45/(1.D0+0.3784699104936427D2*t68)-0.8D-23*(-0.262541105966581
     &1D0*t19*t7*t55-1.D0*t20*t49*t59)/t20*t6+0.2505897912236993D-1*(-0.
     &2067834969664667D0*t42*t26*t45-0.6203504908994D0*t2*t91*t94)*t63*t
     &25+0.6519760588091369D-1*t102*t54*t45/(1.D0+0.2238166941830029D2*t
     &102)+0.2247867096D-2*(-0.2625411059665811D0*t36*t26*t55-1.D0*t37*t
     &91*t94)/t37*t25)
      ID_RB_POS=D1VARS(ID_RB)
      D1F(i, ID_RB_POS) = D1F(i, ID_RB_POS) +      t123 
      END IF
      END IF
      END DO
      RETURN
      END
                   
                   
                   
                   
