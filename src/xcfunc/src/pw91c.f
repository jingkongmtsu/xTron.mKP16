!--------------------------------------------------------------------------
!                 Reference section for the functional:
!--------------------------------------------------------------------------
!  J.P. Perdew, J.A. Chevary, S.H. Vosko, K.A. Jackson, 
!  M.R. Pederson, D.J. Singh and C. Fiolhais, 
!  “Atoms, molecules, solids and surfaces: Applications of the generalized
!   gradient approximation for exchange and correlation”, 
!  Phys. Rev. B, 46(11):6671–6687, 1992
!
!



      subroutine functional_pw91c
     &(INFOR,NG,NDEN,TOL,rhoA,rhoB,DRhoA,DRhoB,F,D1F)
      IMPLICIT NONE
!--------------------------------------------------------
! This routine is used to calculate the functional and
! functional derivatives values up to the third order.
! It's only the interface function, the real calculation
! work will be done by seperate routine.
! INPUT :
! INFOR : information related to the variables
! NG    : the number of grid points
! NDEN  : the number of densities
! TOL   : tolerance value for error
! rhoA  : the alpha electron density
! rhoB  : the beta  electron density
! DRhoA : the alpha rho'
! DRhoB : the beta  rho'
! TauA  : the alpha kinetic energy density
! TauB  : the beta  kinetic energy density
! LapA  : the alpha laplacian density
! LapB  : the beta  laplacian density
! OUTPUT:
! F     : functional values
! D1F   : the first  order functional derivatives
! D2F   : the second order functional derivatives
! D3F   : the third  order functional derivatives
!--------------------------------------------------------
      INTEGER INFOR(*)
      INTEGER NG,NDEN
      DOUBLE PRECISION TOL
      DOUBLE PRECISION rhoA(NG),rhoB(NG)
      DOUBLE PRECISION DRhoA(NG,3),DRhoB(NG,3)
      DOUBLE PRECISION F(NG), D1F(NG,*)
      
      IF (NDEN .EQ. 1) THEN 
      CALL functional_pw91c_close
     &(INFOR,NG,NDEN,TOL,rhoA,DRhoA,F,D1F)
      ELSE  
      CALL functional_pw91c_open
     &(INFOR,NG,NDEN,TOL,rhoA,rhoB,DRhoA,DRhoB,F,D1F)
      END IF  
      RETURN  
      END     



      subroutine functional_pw91c_close
     &(INFOR,NG,NDEN,TOL,rhoA,DRhoA,F,D1F)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
!--------------------------------------------------------
! This routine is used to calculate the functional and
! functional derivatives values up to the third order.
! We note that this routine is used in the close shell case,
! that means, we have RA=RB, GAA=GAB=GBB,TA=TB and LA=LB
! for each grid point.
!--------------------------------------------------------
#include "fderiv1.inc"
      INTEGER INFOR(*)
      INTEGER IDERIV, NG
      DOUBLE PRECISION rhoA(NG)
      DOUBLE PRECISION RA, RB ! rho vaule at each point
      DOUBLE PRECISION DRhoA(NG,3)
      DOUBLE PRECISION GAA, GAB, GBB ! the gamma value at each point
      DOUBLE PRECISION F(NG),D1F(NG,*)
      DOUBLE PRECISION TOL ! tolerance
      DOUBLE PRECISION PI
      INTEGER  D1VARS(N_FUNC_DERIV_1)
      
      ! firstly initilize variable position information
      CALL INIT_FUNC_DERIV_1(INFOR,D1VARS)
      
      ! deal with the constants
      PI    = 4.D0*DATAN(1.D0)
      IDERIV    = 1

      ! the real calculation begins
      DO i = 1,NG
      RA = rhoA(i)
      RB = RA 
      IF (RA.LE.TOL) CYCLE
      GAA = DRhoA(i,1)*DRhoA(i,1) + DRhoA(i,2)*DRhoA(i,2)
     &+ DRhoA(i,3)*DRhoA(i,3)
      GBB = GAA
      GAB = GAA
      t1 = RA+RB
      t2 = PI*t1
      t3 = t2**(1.D0/3.D0)
      t4 = 1/t3
      t7 = t2**(1.D0/6.D0)
      t8 = 1/t7
      t11 = dsqrt(t2)
      t12 = 1/t11
      t14 = t3**2
      t15 = 1/t14
      t21 = dlog(1.D0+0.160819795D2/(0.7240101934316831D1*t8+0.325955091
     &9422292D1*t4+0.1418722816479667D1*t12+0.4069130045175293D0*t15))
      t23 = 0.621814D-1*(0.1941593353441141D0*t4+1.D0)*t21
      t34 = dlog(1.D0+0.2960874998D2/(0.9872129722569272D1*t8+0.32918048
     &09945063D1*t4+0.76232752193529D0*t12+0.4100250709496125D0*t15))
      t37 = RA-1.D0*RB
      t38 = 1/t1
      t39 = t37*t38
      t40 = 1.D0+t39
      t41 = t40**(1.D0/3.D0)
      t44 = 1.D0-1.D0*t39
      t45 = t44**(1.D0/3.D0)
      t47 = t41*t40+t45*t44-2.D0
      t48 = t37**2
      t49 = t48**2
      t50 = t1**2
      t51 = t50**2
      t52 = 1/t51
      t53 = t49*t52
      t58 = 0.37995525D-1*(0.1010773329762878D0*t4+1.D0)*t34*t47*(1.D0-1
     &.D0*t53)
      t69 = dlog(1.D0+0.32163959D2/(0.1345791371439445D2*t8+0.5630984149
     &097876D1*t4+0.2915214714219177D1*t12+0.5160664645478634D0*t15))
      t75 = 0.1923661050931536D1*(-0.310907D-1*(0.186690969707574D0*t4+1
     &.D0)*t69+t23)*t47*t53
      t76 = t41**2
      t78 = t45**2
      t80 = 0.5D0*t76+0.5D0*t78
      t81 = t80**2
      t82 = t81*t80
      t83 = PI**2
      t86 = t83**(1.D0/3.D0)
      t87 = t86**2
      t88 = 1/t86
      t91 = GAA+GBB+2.D0*GAB
      t93 = t91/t81
      t95 = (t83*t1)**(1.D0/3.D0)
      t96 = 1/t95
      t98 = 1/t50
      t107 = 1/t87
      t111 = dexp(-0.1884711471986759D2*(-t23+t58+t75)/t82*t83*t107)
      t112 = t111-1.D0
      t113 = 1/t112
      t115 = t91**2
      t116 = t81**2
      t119 = t95**2
      t120 = 1/t119
      t122 = t115/t116*t120*t52
      t132 = t83**2
      t134 = t112**2
      t145 = dlog(1.D0+0.1841868792121598D1*PI*t88*(0.4333507964691467D-
     &1*t93*t96*PI*t98+0.3458899056D-2*t83*PI*t88*t113*t122)/(1.D0+0.798
     &1753082738971D-1*t83*t88*t113*t93*t96*t98+0.6370838224650364D-2*t1
     &32*t107/t134*t122))
      t169 = dexp(-0.120187464192284D2*t81*t120*t91*t98)
      t174 = t1*(-t23+t58+t75+0.5305851931277703D-1*t82/t83*t87*t145+t86
     &*(0.1D-2*(0.2568D1+0.2113856385641628D2*t4+0.6099485110520599D-2*t
     &15)/(1.D0+0.7925371465637377D1*t4+0.3896274153695659D0*t15+0.55417
     &5D-1/PI*t38)-0.1853571429D-2)*t80*t91*t96*t98*t169)
      F(i) = F(i) +      t174 
      IF (IDERIV .GE. 1) THEN
      t1 = RA+RB
      t2 = PI*t1
      t3 = t2**(1.D0/3.D0)
      t4 = 1/t3
      t6 = 0.1941593353441141D0*t4+1.D0
      t7 = t2**(1.D0/6.D0)
      t8 = 1/t7
      t11 = dsqrt(t2)
      t12 = 1/t11
      t14 = t3**2
      t15 = 1/t14
      t17 = 0.7240101934316831D1*t8+0.3259550919422292D1*t4+0.1418722816
     &479667D1*t12+0.4069130045175293D0*t15
      t20 = 1.D0+0.160819795D2/t17
      t21 = dlog(t20)
      t23 = 0.621814D-1*t6*t21
      t25 = 0.1010773329762878D0*t4+1.D0
      t30 = 0.9872129722569272D1*t8+0.3291804809945063D1*t4+0.7623275219
     &3529D0*t12+0.4100250709496125D0*t15
      t33 = 1.D0+0.2960874998D2/t30
      t34 = dlog(t33)
      t35 = t25*t34
      t37 = RA-1.D0*RB
      t38 = 1/t1
      t39 = t37*t38
      t40 = 1.D0+t39
      t41 = t40**(1.D0/3.D0)
      t44 = 1.D0-1.D0*t39
      t45 = t44**(1.D0/3.D0)
      t47 = t41*t40+t45*t44-2.D0
      t48 = t37**2
      t49 = t48**2
      t50 = t1**2
      t51 = t50**2
      t52 = 1/t51
      t53 = t49*t52
      t55 = 1.D0-1.D0*t53
      t58 = 0.37995525D-1*t35*t47*t55
      t60 = 0.186690969707574D0*t4+1.D0
      t65 = 0.1345791371439445D2*t8+0.5630984149097876D1*t4+0.2915214714
     &219177D1*t12+0.5160664645478634D0*t15
      t68 = 1.D0+0.32163959D2/t65
      t69 = dlog(t68)
      t72 = -0.310907D-1*t60*t69+t23
      t73 = t72*t47
      t75 = 0.1923661050931536D1*t73*t53
      t76 = t41**2
      t78 = t45**2
      t80 = 0.5D0*t76+0.5D0*t78
      t81 = t80**2
      t82 = t81*t80
      t83 = PI**2
      t84 = 1/t83
      t85 = t82*t84
      t86 = t83**(1.D0/3.D0)
      t87 = t86**2
      t88 = 1/t86
      t89 = PI*t88
      t91 = GAA+GBB+2.D0*GAB
      t92 = 1/t81
      t93 = t91*t92
      t94 = t83*t1
      t95 = t94**(1.D0/3.D0)
      t96 = 1/t95
      t97 = t96*PI
      t98 = 1/t50
      t102 = t83*PI
      t103 = t102*t88
      t104 = -t23+t58+t75
      t105 = 1/t82
      t107 = 1/t87
      t108 = t83*t107
      t111 = dexp(-0.1884711471986759D2*t104*t105*t108)
      t112 = t111-1.D0
      t113 = 1/t112
      t114 = t103*t113
      t115 = t91**2
      t116 = t81**2
      t117 = 1/t116
      t118 = t115*t117
      t119 = t95**2
      t120 = 1/t119
      t122 = t118*t120*t52
      t125 = 0.4333507964691467D-1*t93*t97*t98+0.3458899056D-2*t114*t122
      t126 = t83*t88
      t127 = t126*t113
      t128 = t96*t98
      t132 = t83**2
      t133 = t132*t107
      t134 = t112**2
      t135 = 1/t134
      t136 = t133*t135
      t139 = 1.D0+0.7981753082738971D-1*t127*t93*t128+0.6370838224650364
     &D-2*t136*t122
      t140 = 1/t139
      t144 = 1.D0+0.1841868792121598D1*t89*t125*t140
      t145 = dlog(t144)
      t146 = t87*t145
      t151 = 0.2568D1+0.2113856385641628D2*t4+0.6099485110520599D-2*t15
      t154 = 1/PI
      t157 = 1.D0+0.7925371465637377D1*t4+0.3896274153695659D0*t15+0.554
     &175D-1*t154*t38
      t158 = 1/t157
      t162 = t86*(0.1D-2*t151*t158-0.1853571429D-2)
      t163 = t162*t80
      t164 = t91*t96
      t165 = t81*t120
      t166 = t91*t98
      t169 = dexp(-0.120187464192284D2*t165*t166)
      t171 = t164*t98*t169
      t175 = 1/t3/t2*PI
      t176 = t175*t21
      t177 = 0.4024366431588833D-2*t176
      t178 = t17**2
      t183 = 1/t7/t2*PI
      t186 = t11**2
      t189 = 1/t186/t11*PI
      t193 = 1/t14/t2*PI
      t199 = 0.10000000000813D1*t6/t178*(-0.1206683655719472D1*t183-0.10
     &86516973140764D1*t175-0.7093614082398337D0*t189-0.2712753363450195
     &D0*t193)/t20
      t203 = 0.1280162110677955D-2*t175*t34*t47*t55
      t204 = t30**2
      t217 = 0.1125000000083839D1*t25/t204*(-0.1645354953761545D1*t183-0
     &.1097268269981688D1*t175-0.381163760967645D0*t189-0.27335004729974
     &17D0*t193)/t33*t47*t55
      t218 = t37*t98
      t220 = t38-1.D0*t218
      t224 = -1.D0*t38+t218
      t227 = 0.1333333333333333D1*t41*t220+0.1333333333333333D1*t45*t224
      t230 = 0.37995525D-1*t35*t227*t55
      t232 = t48*t37*t52
      t235 = 1/t51/t1
      t236 = t49*t235
      t241 = 0.37995525D-1*t35*t47*(-4.D0*t232+4.D0*t236)
      t244 = t65**2
      t260 = 0.1923661050931536D1*(0.1934784310629091D-2*t175*t69+0.1000
     &0000000813D1*t60/t244*(-0.2242985619065741D1*t183-0.18769947163659
     &59D1*t175-0.1457607357109589D1*t189-0.3440443096985756D0*t193)/t68
     &-0.4024366431588833D-2*t176-t199)*t47*t53
      t263 = 0.1923661050931536D1*t72*t227*t53
      t265 = 0.7694644203726145D1*t73*t232
      t267 = 0.7694644203726145D1*t73*t236
      t275 = 0.3333333333333333D0/t41*t220+0.3333333333333333D0/t45*t224
      t286 = 1/t95/t94
      t292 = 1/t50/t1
      t296 = t135*t115
      t307 = -0.1884711471986759D2*(t177+t199-t203-t217+t230+t241+t260+t
     &263+t265-t267)*t105*t108+0.5654134415960278D2*t104*t117*t108*t275
      t310 = t117*t120*t52*t307*t111
      t319 = 1/t116/t80*t120*t52*t275
      t326 = 1/t119/t94
      t328 = t118*t326*t52
      t332 = t118*t120*t235
      t339 = t139**2
      t359 = t286*t98
      t398 = t157**2
      t415 = t162*t80*t91
      s1 = t177+t199-t203-t217+t230+t241+t260+t263
      s3 = s1+t265
      s4 = s3-t267
      s2 = s4+0.1591755579383311D0*t81*t84*t146*t275+0.5305851931277703D
     &-1*t85*t87*(0.1841868792121598D1*t89*(-0.8667015929382934D-1*t91*t
     &105*t96*PI*t98*t275-0.1444502654897156D-1*t93*t286*t102*t98-0.8667
     &015929382934D-1*t93*t97*t292-0.3458899056D-2*t103*t296*t310-0.1383
     &5596224D-1*t103*t113*t115*t319-0.2305932704D-2*t132*PI*t88*t113*t3
     &28-0.13835596224D-1*t114*t332)*t140-0.1841868792121598D1*t89*t125/
     &t339*(-0.7981753082738971D-1*t126*t135*t91*t92*t96*t98*t307*t111-0
     &.1596350616547794D0*t126*t113*t91*t105*t96*t98*t275-0.266058436091
     &299D-1*t132*t88*t113*t93*t359-0.1596350616547794D0*t127*t93*t96*t2
     &92-0.1274167644930073D-1*t133/t134/t112*t115*t310-0.25483352898601
     &46D-1*t133*t296*t319-0.4247225483100243D-2*t132*t83*t107*t135*t328
     &-0.2548335289860146D-1*t136*t332))/t144
      t439 = s2+t86*(0.1D-2*(-0.704618795213876D1*t175-0.406632340701373
     &3D-2*t193)*t158-0.1D-2*t151/t398*(-0.2641790488545792D1*t175-0.259
     &7516102463773D0*t193-0.554175D-1*t154*t98))*t80*t171+t162*t275*t17
     &1-0.3333333333333333D0*t415*t359*t169*t83-2.D0*t163*t164*t292*t169
     &+t415*t128*(-0.2403749283845681D2*t80*t120*t166*t275+0.80124976128
     &18935D1*t81*t326*t166*t83+0.2403749283845681D2*t165*t91*t292)*t169
      t441 = -t23+t58+t75+0.5305851931277703D-1*t85*t146+t163*t171+t1*t4
     &39
      ID_RA_POS=D1VARS(ID_RA)
      D1F(i, ID_RA_POS) = D1F(i, ID_RA_POS) +      t441 
      t1 = RA+RB
      t3 = RA-1.D0*RB
      t4 = 1/t1
      t5 = t3*t4
      t6 = t5+1.D0
      t7 = t6**(1.D0/3.D0)
      t8 = t7**2
      t11 = 1.D0-1.D0*t5
      t12 = t11**(1.D0/3.D0)
      t13 = t12**2
      t15 = 0.5D0*t8+0.5D0*t13
      t16 = t15**2
      t17 = t16*t15
      t18 = PI**2
      t19 = 1/t18
      t21 = t18**(1.D0/3.D0)
      t22 = t21**2
      t23 = 1/t21
      t24 = PI*t23
      t25 = 1/t16
      t27 = (t18*t1)**(1.D0/3.D0)
      t28 = 1/t27
      t29 = t25*t28
      t30 = t1**2
      t31 = 1/t30
      t37 = PI*t1
      t38 = t37**(1.D0/3.D0)
      t39 = 1/t38
      t42 = t37**(1.D0/6.D0)
      t43 = 1/t42
      t46 = dsqrt(t37)
      t47 = 1/t46
      t49 = t38**2
      t50 = 1/t49
      t56 = dlog(1.D0+0.160819795D2/(0.7240101934316831D1*t43+0.32595509
     &19422292D1*t39+0.1418722816479667D1*t47+0.4069130045175293D0*t50))
      t58 = 0.621814D-1*(0.1941593353441141D0*t39+1.D0)*t56
      t69 = dlog(1.D0+0.2960874998D2/(0.9872129722569272D1*t43+0.3291804
     &809945063D1*t39+0.76232752193529D0*t47+0.4100250709496125D0*t50))
      t73 = t7*t6+t12*t11-2.D0
      t74 = t3**2
      t75 = t74**2
      t76 = t30**2
      t77 = 1/t76
      t78 = t75*t77
      t94 = dlog(1.D0+0.32163959D2/(0.1345791371439445D2*t43+0.563098414
     &9097876D1*t39+0.2915214714219177D1*t47+0.5160664645478634D0*t50))
      t104 = 1/t22
      t108 = dexp(-0.1884711471986759D2*(-t58+0.37995525D-1*(0.101077332
     &9762878D0*t39+1.D0)*t69*t73*(1.D0-1.D0*t78)+0.1923661050931536D1*(
     &-0.310907D-1*(0.186690969707574D0*t39+1.D0)*t94+t58)*t73*t78)/t17*
     &t18*t104)
      t109 = t108-1.D0
      t110 = 1/t109
      t111 = t18*PI*t23*t110
      t113 = GAA+GBB+2.D0*GAB
      t114 = t16**2
      t115 = 1/t114
      t117 = t27**2
      t118 = 1/t117
      t119 = t118*t77
      t120 = t113*t115*t119
      t125 = t18*t23*t110
      t126 = t113*t25
      t127 = t28*t31
      t131 = t18**2
      t133 = t109**2
      t135 = t131*t104/t133
      t136 = t113**2
      t138 = t136*t115*t119
      t141 = 1.D0+0.7981753082738971D-1*t125*t126*t127+0.637083822465036
     &4D-2*t135*t138
      t142 = 1/t141
      t152 = 0.4333507964691467D-1*t126*t28*PI*t31+0.3458899056D-2*t111*
     &t138
      t153 = t141**2
      t188 = t21*(0.1D-2*(0.2568D1+0.2113856385641628D2*t39+0.6099485110
     &520599D-2*t50)/(1.D0+0.7925371465637377D1*t39+0.3896274153695659D0
     &*t50+0.554175D-1/PI*t4)-0.1853571429D-2)
      t194 = dexp(-0.120187464192284D2*t16*t118*t113*t31)
      t206 = t1*(0.5305851931277703D-1*t17*t19*t22*(0.1841868792121598D1
     &*t24*(0.4333507964691467D-1*t29*PI*t31+0.6917798112D-2*t111*t120)*
     &t142-0.1841868792121598D1*t24*t152/t153*(0.7981753082738971D-1*t12
     &5*t29*t31+0.1274167644930073D-1*t135*t120))/(1.D0+0.18418687921215
     &98D1*t24*t152*t142)+t188*t15*t127*t194-0.120187464192284D2*t188*t1
     &7*t113*t19/t76/t1*t194)
      ID_GAA_POS=D1VARS(ID_GAA)
      D1F(i, ID_GAA_POS) = D1F(i, ID_GAA_POS) +      t206 
      t1 = RA+RB
      t3 = RA-1.D0*RB
      t4 = 1/t1
      t5 = t3*t4
      t6 = t5+1.D0
      t7 = t6**(1.D0/3.D0)
      t8 = t7**2
      t11 = 1.D0-1.D0*t5
      t12 = t11**(1.D0/3.D0)
      t13 = t12**2
      t15 = 0.5D0*t8+0.5D0*t13
      t16 = t15**2
      t17 = t16*t15
      t18 = PI**2
      t19 = 1/t18
      t21 = t18**(1.D0/3.D0)
      t22 = t21**2
      t23 = 1/t21
      t24 = PI*t23
      t25 = 1/t16
      t27 = (t18*t1)**(1.D0/3.D0)
      t28 = 1/t27
      t29 = t25*t28
      t30 = t1**2
      t31 = 1/t30
      t37 = PI*t1
      t38 = t37**(1.D0/3.D0)
      t39 = 1/t38
      t42 = t37**(1.D0/6.D0)
      t43 = 1/t42
      t46 = dsqrt(t37)
      t47 = 1/t46
      t49 = t38**2
      t50 = 1/t49
      t56 = dlog(1.D0+0.160819795D2/(0.7240101934316831D1*t43+0.32595509
     &19422292D1*t39+0.1418722816479667D1*t47+0.4069130045175293D0*t50))
      t58 = 0.621814D-1*(0.1941593353441141D0*t39+1.D0)*t56
      t69 = dlog(1.D0+0.2960874998D2/(0.9872129722569272D1*t43+0.3291804
     &809945063D1*t39+0.76232752193529D0*t47+0.4100250709496125D0*t50))
      t73 = t7*t6+t12*t11-2.D0
      t74 = t3**2
      t75 = t74**2
      t76 = t30**2
      t77 = 1/t76
      t78 = t75*t77
      t94 = dlog(1.D0+0.32163959D2/(0.1345791371439445D2*t43+0.563098414
     &9097876D1*t39+0.2915214714219177D1*t47+0.5160664645478634D0*t50))
      t104 = 1/t22
      t108 = dexp(-0.1884711471986759D2*(-t58+0.37995525D-1*(0.101077332
     &9762878D0*t39+1.D0)*t69*t73*(1.D0-1.D0*t78)+0.1923661050931536D1*(
     &-0.310907D-1*(0.186690969707574D0*t39+1.D0)*t94+t58)*t73*t78)/t17*
     &t18*t104)
      t109 = t108-1.D0
      t110 = 1/t109
      t111 = t18*PI*t23*t110
      t113 = GAA+GBB+2.D0*GAB
      t114 = t16**2
      t115 = 1/t114
      t117 = t27**2
      t118 = 1/t117
      t119 = t118*t77
      t120 = t113*t115*t119
      t125 = t18*t23*t110
      t126 = t113*t25
      t127 = t28*t31
      t131 = t18**2
      t133 = t109**2
      t135 = t131*t104/t133
      t136 = t113**2
      t138 = t136*t115*t119
      t141 = 1.D0+0.7981753082738971D-1*t125*t126*t127+0.637083822465036
     &4D-2*t135*t138
      t142 = 1/t141
      t152 = 0.4333507964691467D-1*t126*t28*PI*t31+0.3458899056D-2*t111*
     &t138
      t153 = t141**2
      t188 = t21*(0.1D-2*(0.2568D1+0.2113856385641628D2*t39+0.6099485110
     &520599D-2*t50)/(1.D0+0.7925371465637377D1*t39+0.3896274153695659D0
     &*t50+0.554175D-1/PI*t4)-0.1853571429D-2)
      t194 = dexp(-0.120187464192284D2*t16*t118*t113*t31)
      t207 = t1*(0.5305851931277703D-1*t17*t19*t22*(0.1841868792121598D1
     &*t24*(0.8667015929382934D-1*t29*PI*t31+0.13835596224D-1*t111*t120)
     &*t142-0.1841868792121598D1*t24*t152/t153*(0.1596350616547794D0*t12
     &5*t29*t31+0.2548335289860146D-1*t135*t120))/(1.D0+0.18418687921215
     &98D1*t24*t152*t142)+2.D0*t188*t15*t127*t194-0.2403749283845681D2*t
     &188*t17*t113*t19/t76/t1*t194)
      ID_GAB_POS=D1VARS(ID_GAB)
      D1F(i, ID_GAB_POS) = D1F(i, ID_GAB_POS) +      t207 
      END IF
      IF (IDERIV .GE. 1) THEN
      ID_GBB_POS=D1VARS(ID_GBB)
      D1F(i, ID_GBB_POS)= D1F(i, ID_GAA_POS)
      ID_RB_POS=D1VARS(ID_RB)
      D1F(i, ID_RB_POS)= D1F(i, ID_RA_POS)
      END IF
      END DO
      RETURN
      END
                   
                   
                   
                   
      subroutine functional_pw91c_open
     &(INFOR,NG,NDEN,TOL,rhoA,rhoB,DRhoA,DRhoB,F,D1F)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
!--------------------------------------------------------
! This routine is used to calculate the functional and
! functional derivatives values up to the third order.
! We note that this routine is used in the open shell case.
!--------------------------------------------------------
#include "fderiv1.inc"
      INTEGER INFOR(*)
      INTEGER IDERIV, NG
      DOUBLE PRECISION rhoA(NG)
      DOUBLE PRECISION RA, RB ! rho vaule at each point
      DOUBLE PRECISION DRhoA(NG,3)
      DOUBLE PRECISION GAA, GAB, GBB ! the gamma value at each point
      DOUBLE PRECISION rhoB(NG)
      DOUBLE PRECISION DRhoB(NG,3)
      DOUBLE PRECISION F(NG),D1F(NG,*)
      DOUBLE PRECISION TOL ! tolerance
      DOUBLE PRECISION PI
      INTEGER  D1VARS(N_FUNC_DERIV_1)
      
      ! firstly initilize variable position information
      CALL INIT_FUNC_DERIV_1(INFOR,D1VARS)
      
      ! deal with the constants
      PI    = 4.D0*DATAN(1.D0)
      IDERIV    = 1

      ! the real calculation begins
      DO i = 1,NG
         RA = rhoA(i)
         RB = rhoB(i)
         GAA = DRhoA(i,1)*DRhoA(i,1) + DRhoA(i,2)*DRhoA(i,2)
     &+ DRhoA(i,3)*DRhoA(i,3)
         GBB = DRhoB(i,1)*DRhoB(i,1) + DRhoB(i,2)*DRhoB(i,2)
     &+ DRhoB(i,3)*DRhoB(i,3)
         GAB = DRhoA(i,1)*DRhoB(i,1) + DRhoA(i,2)*DRhoB(i,2)
     &+ DRhoA(i,3)*DRhoB(i,3)
      IF (RB.LE.TOL) THEN
         RB = 0.0D0 
         GBB = 0.0D0
         GAB = 0.0D0
      END IF 
      IF (RA.LE.TOL) THEN
         RA = 0.0D0 
         GAA = 0.0D0
         GAB = 0.0D0
      END IF 
      IF (RA.LE.TOL .AND. RB.LE.TOL) THEN
         CYCLE 
      END IF 
             
      IF (RA.GT.TOL .AND. RB.GT.TOL) THEN
      t1 = RA+RB
      t2 = PI*t1
      t3 = t2**(1.D0/3.D0)
      t4 = 1/t3
      t7 = t2**(1.D0/6.D0)
      t8 = 1/t7
      t11 = dsqrt(t2)
      t12 = 1/t11
      t14 = t3**2
      t15 = 1/t14
      t21 = dlog(1.D0+0.160819795D2/(0.7240101934316831D1*t8+0.325955091
     &9422292D1*t4+0.1418722816479667D1*t12+0.4069130045175293D0*t15))
      t23 = 0.621814D-1*(0.1941593353441141D0*t4+1.D0)*t21
      t34 = dlog(1.D0+0.2960874998D2/(0.9872129722569272D1*t8+0.32918048
     &09945063D1*t4+0.76232752193529D0*t12+0.4100250709496125D0*t15))
      t37 = RA-1.D0*RB
      t38 = 1/t1
      t39 = t37*t38
      t40 = 1.D0+t39
      t41 = t40**(1.D0/3.D0)
      t44 = 1.D0-1.D0*t39
      t45 = t44**(1.D0/3.D0)
      t47 = t41*t40+t45*t44-2.D0
      t48 = t37**2
      t49 = t48**2
      t50 = t1**2
      t51 = t50**2
      t52 = 1/t51
      t53 = t49*t52
      t58 = 0.37995525D-1*(0.1010773329762878D0*t4+1.D0)*t34*t47*(1.D0-1
     &.D0*t53)
      t69 = dlog(1.D0+0.32163959D2/(0.1345791371439445D2*t8+0.5630984149
     &097876D1*t4+0.2915214714219177D1*t12+0.5160664645478634D0*t15))
      t75 = 0.1923661050931536D1*(-0.310907D-1*(0.186690969707574D0*t4+1
     &.D0)*t69+t23)*t47*t53
      t76 = t41**2
      t78 = t45**2
      t80 = 0.5D0*t76+0.5D0*t78
      t81 = t80**2
      t82 = t81*t80
      t83 = PI**2
      t86 = t83**(1.D0/3.D0)
      t87 = t86**2
      t88 = 1/t86
      t91 = GAA+GBB+2.D0*GAB
      t93 = t91/t81
      t95 = (t83*t1)**(1.D0/3.D0)
      t96 = 1/t95
      t98 = 1/t50
      t107 = 1/t87
      t111 = dexp(-0.1884711471986759D2*(-t23+t58+t75)/t82*t83*t107)
      t112 = t111-1.D0
      t113 = 1/t112
      t115 = t91**2
      t116 = t81**2
      t119 = t95**2
      t120 = 1/t119
      t122 = t115/t116*t120*t52
      t132 = t83**2
      t134 = t112**2
      t145 = dlog(1.D0+0.1841868792121598D1*PI*t88*(0.4333507964691467D-
     &1*t93*t96*PI*t98+0.3458899056D-2*t83*PI*t88*t113*t122)/(1.D0+0.798
     &1753082738971D-1*t83*t88*t113*t93*t96*t98+0.6370838224650364D-2*t1
     &32*t107/t134*t122))
      t169 = dexp(-0.120187464192284D2*t81*t120*t91*t98)
      t174 = t1*(-t23+t58+t75+0.5305851931277703D-1*t82/t83*t87*t145+t86
     &*(0.1D-2*(0.2568D1+0.2113856385641628D2*t4+0.6099485110520599D-2*t
     &15)/(1.D0+0.7925371465637377D1*t4+0.3896274153695659D0*t15+0.55417
     &5D-1/PI*t38)-0.1853571429D-2)*t80*t91*t96*t98*t169)
      F(i) = F(i) +      t174 
      IF (IDERIV .GE. 1) THEN
      t1 = RA+RB
      t2 = PI*t1
      t3 = t2**(1.D0/3.D0)
      t4 = 1/t3
      t6 = 0.1941593353441141D0*t4+1.D0
      t7 = t2**(1.D0/6.D0)
      t8 = 1/t7
      t11 = dsqrt(t2)
      t12 = 1/t11
      t14 = t3**2
      t15 = 1/t14
      t17 = 0.7240101934316831D1*t8+0.3259550919422292D1*t4+0.1418722816
     &479667D1*t12+0.4069130045175293D0*t15
      t20 = 1.D0+0.160819795D2/t17
      t21 = dlog(t20)
      t23 = 0.621814D-1*t6*t21
      t25 = 0.1010773329762878D0*t4+1.D0
      t30 = 0.9872129722569272D1*t8+0.3291804809945063D1*t4+0.7623275219
     &3529D0*t12+0.4100250709496125D0*t15
      t33 = 1.D0+0.2960874998D2/t30
      t34 = dlog(t33)
      t35 = t25*t34
      t37 = RA-1.D0*RB
      t38 = 1/t1
      t39 = t37*t38
      t40 = 1.D0+t39
      t41 = t40**(1.D0/3.D0)
      t44 = 1.D0-1.D0*t39
      t45 = t44**(1.D0/3.D0)
      t47 = t41*t40+t45*t44-2.D0
      t48 = t37**2
      t49 = t48**2
      t50 = t1**2
      t51 = t50**2
      t52 = 1/t51
      t53 = t49*t52
      t55 = 1.D0-1.D0*t53
      t58 = 0.37995525D-1*t35*t47*t55
      t60 = 0.186690969707574D0*t4+1.D0
      t65 = 0.1345791371439445D2*t8+0.5630984149097876D1*t4+0.2915214714
     &219177D1*t12+0.5160664645478634D0*t15
      t68 = 1.D0+0.32163959D2/t65
      t69 = dlog(t68)
      t72 = -0.310907D-1*t60*t69+t23
      t73 = t72*t47
      t75 = 0.1923661050931536D1*t73*t53
      t76 = t41**2
      t78 = t45**2
      t80 = 0.5D0*t76+0.5D0*t78
      t81 = t80**2
      t82 = t81*t80
      t83 = PI**2
      t84 = 1/t83
      t85 = t82*t84
      t86 = t83**(1.D0/3.D0)
      t87 = t86**2
      t88 = 1/t86
      t89 = PI*t88
      t91 = GAA+GBB+2.D0*GAB
      t92 = 1/t81
      t93 = t91*t92
      t94 = t83*t1
      t95 = t94**(1.D0/3.D0)
      t96 = 1/t95
      t97 = t96*PI
      t98 = 1/t50
      t102 = t83*PI
      t103 = t102*t88
      t104 = -t23+t58+t75
      t105 = 1/t82
      t107 = 1/t87
      t108 = t83*t107
      t111 = dexp(-0.1884711471986759D2*t104*t105*t108)
      t112 = t111-1.D0
      t113 = 1/t112
      t114 = t103*t113
      t115 = t91**2
      t116 = t81**2
      t117 = 1/t116
      t118 = t115*t117
      t119 = t95**2
      t120 = 1/t119
      t122 = t118*t120*t52
      t125 = 0.4333507964691467D-1*t93*t97*t98+0.3458899056D-2*t114*t122
      t126 = t83*t88
      t127 = t126*t113
      t128 = t96*t98
      t132 = t83**2
      t133 = t132*t107
      t134 = t112**2
      t135 = 1/t134
      t136 = t133*t135
      t139 = 1.D0+0.7981753082738971D-1*t127*t93*t128+0.6370838224650364
     &D-2*t136*t122
      t140 = 1/t139
      t144 = 1.D0+0.1841868792121598D1*t89*t125*t140
      t145 = dlog(t144)
      t146 = t87*t145
      t151 = 0.2568D1+0.2113856385641628D2*t4+0.6099485110520599D-2*t15
      t154 = 1/PI
      t157 = 1.D0+0.7925371465637377D1*t4+0.3896274153695659D0*t15+0.554
     &175D-1*t154*t38
      t158 = 1/t157
      t162 = t86*(0.1D-2*t151*t158-0.1853571429D-2)
      t163 = t162*t80
      t164 = t91*t96
      t165 = t81*t120
      t166 = t91*t98
      t169 = dexp(-0.120187464192284D2*t165*t166)
      t171 = t164*t98*t169
      t175 = 1/t3/t2*PI
      t176 = t175*t21
      t177 = 0.4024366431588833D-2*t176
      t178 = t17**2
      t183 = 1/t7/t2*PI
      t186 = t11**2
      t189 = 1/t186/t11*PI
      t193 = 1/t14/t2*PI
      t199 = 0.10000000000813D1*t6/t178*(-0.1206683655719472D1*t183-0.10
     &86516973140764D1*t175-0.7093614082398337D0*t189-0.2712753363450195
     &D0*t193)/t20
      t203 = 0.1280162110677955D-2*t175*t34*t47*t55
      t204 = t30**2
      t217 = 0.1125000000083839D1*t25/t204*(-0.1645354953761545D1*t183-0
     &.1097268269981688D1*t175-0.381163760967645D0*t189-0.27335004729974
     &17D0*t193)/t33*t47*t55
      t218 = t37*t98
      t220 = t38-1.D0*t218
      t224 = -1.D0*t38+t218
      t227 = 0.1333333333333333D1*t41*t220+0.1333333333333333D1*t45*t224
      t230 = 0.37995525D-1*t35*t227*t55
      t232 = t48*t37*t52
      t235 = 1/t51/t1
      t236 = t49*t235
      t241 = 0.37995525D-1*t35*t47*(-4.D0*t232+4.D0*t236)
      t244 = t65**2
      t260 = 0.1923661050931536D1*(0.1934784310629091D-2*t175*t69+0.1000
     &0000000813D1*t60/t244*(-0.2242985619065741D1*t183-0.18769947163659
     &59D1*t175-0.1457607357109589D1*t189-0.3440443096985756D0*t193)/t68
     &-0.4024366431588833D-2*t176-t199)*t47*t53
      t263 = 0.1923661050931536D1*t72*t227*t53
      t265 = 0.7694644203726145D1*t73*t232
      t267 = 0.7694644203726145D1*t73*t236
      t275 = 0.3333333333333333D0/t41*t220+0.3333333333333333D0/t45*t224
      t286 = 1/t95/t94
      t292 = 1/t50/t1
      t296 = t135*t115
      t307 = -0.1884711471986759D2*(t177+t199-t203-t217+t230+t241+t260+t
     &263+t265-t267)*t105*t108+0.5654134415960278D2*t104*t117*t108*t275
      t310 = t117*t120*t52*t307*t111
      t319 = 1/t116/t80*t120*t52*t275
      t326 = 1/t119/t94
      t328 = t118*t326*t52
      t332 = t118*t120*t235
      t339 = t139**2
      t359 = t286*t98
      t398 = t157**2
      t415 = t162*t80*t91
      s1 = t177+t199-t203-t217+t230+t241+t260+t263
      s3 = s1+t265
      s4 = s3-t267
      s2 = s4+0.1591755579383311D0*t81*t84*t146*t275+0.5305851931277703D
     &-1*t85*t87*(0.1841868792121598D1*t89*(-0.8667015929382934D-1*t91*t
     &105*t96*PI*t98*t275-0.1444502654897156D-1*t93*t286*t102*t98-0.8667
     &015929382934D-1*t93*t97*t292-0.3458899056D-2*t103*t296*t310-0.1383
     &5596224D-1*t103*t113*t115*t319-0.2305932704D-2*t132*PI*t88*t113*t3
     &28-0.13835596224D-1*t114*t332)*t140-0.1841868792121598D1*t89*t125/
     &t339*(-0.7981753082738971D-1*t126*t135*t91*t92*t96*t98*t307*t111-0
     &.1596350616547794D0*t126*t113*t91*t105*t96*t98*t275-0.266058436091
     &299D-1*t132*t88*t113*t93*t359-0.1596350616547794D0*t127*t93*t96*t2
     &92-0.1274167644930073D-1*t133/t134/t112*t115*t310-0.25483352898601
     &46D-1*t133*t296*t319-0.4247225483100243D-2*t132*t83*t107*t135*t328
     &-0.2548335289860146D-1*t136*t332))/t144
      t439 = s2+t86*(0.1D-2*(-0.704618795213876D1*t175-0.406632340701373
     &3D-2*t193)*t158-0.1D-2*t151/t398*(-0.2641790488545792D1*t175-0.259
     &7516102463773D0*t193-0.554175D-1*t154*t98))*t80*t171+t162*t275*t17
     &1-0.3333333333333333D0*t415*t359*t169*t83-2.D0*t163*t164*t292*t169
     &+t415*t128*(-0.2403749283845681D2*t80*t120*t166*t275+0.80124976128
     &18935D1*t81*t326*t166*t83+0.2403749283845681D2*t165*t91*t292)*t169
      t441 = -t23+t58+t75+0.5305851931277703D-1*t85*t146+t163*t171+t1*t4
     &39
      ID_RA_POS=D1VARS(ID_RA)
      D1F(i, ID_RA_POS) = D1F(i, ID_RA_POS) +      t441 
      t1 = RA+RB
      t2 = PI*t1
      t3 = t2**(1.D0/3.D0)
      t4 = 1/t3
      t6 = 0.1941593353441141D0*t4+1.D0
      t7 = t2**(1.D0/6.D0)
      t8 = 1/t7
      t11 = dsqrt(t2)
      t12 = 1/t11
      t14 = t3**2
      t15 = 1/t14
      t17 = 0.7240101934316831D1*t8+0.3259550919422292D1*t4+0.1418722816
     &479667D1*t12+0.4069130045175293D0*t15
      t20 = 1.D0+0.160819795D2/t17
      t21 = dlog(t20)
      t23 = 0.621814D-1*t6*t21
      t25 = 0.1010773329762878D0*t4+1.D0
      t30 = 0.9872129722569272D1*t8+0.3291804809945063D1*t4+0.7623275219
     &3529D0*t12+0.4100250709496125D0*t15
      t33 = 1.D0+0.2960874998D2/t30
      t34 = dlog(t33)
      t35 = t25*t34
      t37 = RA-1.D0*RB
      t38 = 1/t1
      t39 = t37*t38
      t40 = 1.D0+t39
      t41 = t40**(1.D0/3.D0)
      t44 = 1.D0-1.D0*t39
      t45 = t44**(1.D0/3.D0)
      t47 = t41*t40+t45*t44-2.D0
      t48 = t37**2
      t49 = t48**2
      t50 = t1**2
      t51 = t50**2
      t52 = 1/t51
      t53 = t49*t52
      t55 = 1.D0-1.D0*t53
      t58 = 0.37995525D-1*t35*t47*t55
      t60 = 0.186690969707574D0*t4+1.D0
      t65 = 0.1345791371439445D2*t8+0.5630984149097876D1*t4+0.2915214714
     &219177D1*t12+0.5160664645478634D0*t15
      t68 = 1.D0+0.32163959D2/t65
      t69 = dlog(t68)
      t72 = -0.310907D-1*t60*t69+t23
      t73 = t72*t47
      t75 = 0.1923661050931536D1*t73*t53
      t76 = t41**2
      t78 = t45**2
      t80 = 0.5D0*t76+0.5D0*t78
      t81 = t80**2
      t82 = t81*t80
      t83 = PI**2
      t84 = 1/t83
      t85 = t82*t84
      t86 = t83**(1.D0/3.D0)
      t87 = t86**2
      t88 = 1/t86
      t89 = PI*t88
      t91 = GAA+GBB+2.D0*GAB
      t92 = 1/t81
      t93 = t91*t92
      t94 = t83*t1
      t95 = t94**(1.D0/3.D0)
      t96 = 1/t95
      t97 = t96*PI
      t98 = 1/t50
      t102 = t83*PI
      t103 = t102*t88
      t104 = -t23+t58+t75
      t105 = 1/t82
      t107 = 1/t87
      t108 = t83*t107
      t111 = dexp(-0.1884711471986759D2*t104*t105*t108)
      t112 = t111-1.D0
      t113 = 1/t112
      t114 = t103*t113
      t115 = t91**2
      t116 = t81**2
      t117 = 1/t116
      t118 = t115*t117
      t119 = t95**2
      t120 = 1/t119
      t122 = t118*t120*t52
      t125 = 0.4333507964691467D-1*t93*t97*t98+0.3458899056D-2*t114*t122
      t126 = t83*t88
      t127 = t126*t113
      t128 = t96*t98
      t132 = t83**2
      t133 = t132*t107
      t134 = t112**2
      t135 = 1/t134
      t136 = t133*t135
      t139 = 1.D0+0.7981753082738971D-1*t127*t93*t128+0.6370838224650364
     &D-2*t136*t122
      t140 = 1/t139
      t144 = 1.D0+0.1841868792121598D1*t89*t125*t140
      t145 = dlog(t144)
      t146 = t87*t145
      t151 = 0.2568D1+0.2113856385641628D2*t4+0.6099485110520599D-2*t15
      t154 = 1/PI
      t157 = 1.D0+0.7925371465637377D1*t4+0.3896274153695659D0*t15+0.554
     &175D-1*t154*t38
      t158 = 1/t157
      t162 = t86*(0.1D-2*t151*t158-0.1853571429D-2)
      t163 = t162*t80
      t164 = t91*t96
      t165 = t81*t120
      t166 = t91*t98
      t169 = dexp(-0.120187464192284D2*t165*t166)
      t171 = t164*t98*t169
      t175 = 1/t3/t2*PI
      t176 = t175*t21
      t177 = 0.4024366431588833D-2*t176
      t178 = t17**2
      t183 = 1/t7/t2*PI
      t186 = t11**2
      t189 = 1/t186/t11*PI
      t193 = 1/t14/t2*PI
      t199 = 0.10000000000813D1*t6/t178*(-0.1206683655719472D1*t183-0.10
     &86516973140764D1*t175-0.7093614082398337D0*t189-0.2712753363450195
     &D0*t193)/t20
      t203 = 0.1280162110677955D-2*t175*t34*t47*t55
      t204 = t30**2
      t217 = 0.1125000000083839D1*t25/t204*(-0.1645354953761545D1*t183-0
     &.1097268269981688D1*t175-0.381163760967645D0*t189-0.27335004729974
     &17D0*t193)/t33*t47*t55
      t219 = t37*t98
      t221 = -1.D0*t38-1.D0*t219
      t224 = t38+t219
      t227 = 0.1333333333333333D1*t41*t221+0.1333333333333333D1*t45*t224
      t230 = 0.37995525D-1*t35*t227*t55
      t232 = t48*t37*t52
      t235 = 1/t51/t1
      t236 = t49*t235
      t241 = 0.37995525D-1*t35*t47*(4.D0*t232+4.D0*t236)
      t244 = t65**2
      t260 = 0.1923661050931536D1*(0.1934784310629091D-2*t175*t69+0.1000
     &0000000813D1*t60/t244*(-0.2242985619065741D1*t183-0.18769947163659
     &59D1*t175-0.1457607357109589D1*t189-0.3440443096985756D0*t193)/t68
     &-0.4024366431588833D-2*t176-t199)*t47*t53
      t263 = 0.1923661050931536D1*t72*t227*t53
      t265 = 0.7694644203726145D1*t73*t232
      t267 = 0.7694644203726145D1*t73*t236
      t275 = 0.3333333333333333D0/t41*t221+0.3333333333333333D0/t45*t224
      t286 = 1/t95/t94
      t292 = 1/t50/t1
      t296 = t135*t115
      t307 = -0.1884711471986759D2*(t177+t199-t203-t217+t230+t241+t260+t
     &263-t265-t267)*t105*t108+0.5654134415960278D2*t104*t117*t108*t275
      t310 = t117*t120*t52*t307*t111
      t319 = 1/t116/t80*t120*t52*t275
      t326 = 1/t119/t94
      t328 = t118*t326*t52
      t332 = t118*t120*t235
      t339 = t139**2
      t359 = t286*t98
      t398 = t157**2
      t415 = t162*t80*t91
      s1 = t177+t199-t203-t217+t230+t241+t260+t263
      s3 = s1-t265
      s4 = s3-t267
      s2 = s4+0.1591755579383311D0*t81*t84*t146*t275+0.5305851931277703D
     &-1*t85*t87*(0.1841868792121598D1*t89*(-0.8667015929382934D-1*t91*t
     &105*t96*PI*t98*t275-0.1444502654897156D-1*t93*t286*t102*t98-0.8667
     &015929382934D-1*t93*t97*t292-0.3458899056D-2*t103*t296*t310-0.1383
     &5596224D-1*t103*t113*t115*t319-0.2305932704D-2*t132*PI*t88*t113*t3
     &28-0.13835596224D-1*t114*t332)*t140-0.1841868792121598D1*t89*t125/
     &t339*(-0.7981753082738971D-1*t126*t135*t91*t92*t96*t98*t307*t111-0
     &.1596350616547794D0*t126*t113*t91*t105*t96*t98*t275-0.266058436091
     &299D-1*t132*t88*t113*t93*t359-0.1596350616547794D0*t127*t93*t96*t2
     &92-0.1274167644930073D-1*t133/t134/t112*t115*t310-0.25483352898601
     &46D-1*t133*t296*t319-0.4247225483100243D-2*t132*t83*t107*t135*t328
     &-0.2548335289860146D-1*t136*t332))/t144
      t439 = s2+t86*(0.1D-2*(-0.704618795213876D1*t175-0.406632340701373
     &3D-2*t193)*t158-0.1D-2*t151/t398*(-0.2641790488545792D1*t175-0.259
     &7516102463773D0*t193-0.554175D-1*t154*t98))*t80*t171+t162*t275*t17
     &1-0.3333333333333333D0*t415*t359*t169*t83-2.D0*t163*t164*t292*t169
     &+t415*t128*(-0.2403749283845681D2*t80*t120*t166*t275+0.80124976128
     &18935D1*t81*t326*t166*t83+0.2403749283845681D2*t165*t91*t292)*t169
      t441 = -t23+t58+t75+0.5305851931277703D-1*t85*t146+t163*t171+t1*t4
     &39
      ID_RB_POS=D1VARS(ID_RB)
      D1F(i, ID_RB_POS) = D1F(i, ID_RB_POS) +      t441 
      t1 = RA+RB
      t3 = RA-1.D0*RB
      t4 = 1/t1
      t5 = t3*t4
      t6 = t5+1.D0
      t7 = t6**(1.D0/3.D0)
      t8 = t7**2
      t11 = 1.D0-1.D0*t5
      t12 = t11**(1.D0/3.D0)
      t13 = t12**2
      t15 = 0.5D0*t8+0.5D0*t13
      t16 = t15**2
      t17 = t16*t15
      t18 = PI**2
      t19 = 1/t18
      t21 = t18**(1.D0/3.D0)
      t22 = t21**2
      t23 = 1/t21
      t24 = PI*t23
      t25 = 1/t16
      t27 = (t18*t1)**(1.D0/3.D0)
      t28 = 1/t27
      t29 = t25*t28
      t30 = t1**2
      t31 = 1/t30
      t37 = PI*t1
      t38 = t37**(1.D0/3.D0)
      t39 = 1/t38
      t42 = t37**(1.D0/6.D0)
      t43 = 1/t42
      t46 = dsqrt(t37)
      t47 = 1/t46
      t49 = t38**2
      t50 = 1/t49
      t56 = dlog(1.D0+0.160819795D2/(0.7240101934316831D1*t43+0.32595509
     &19422292D1*t39+0.1418722816479667D1*t47+0.4069130045175293D0*t50))
      t58 = 0.621814D-1*(0.1941593353441141D0*t39+1.D0)*t56
      t69 = dlog(1.D0+0.2960874998D2/(0.9872129722569272D1*t43+0.3291804
     &809945063D1*t39+0.76232752193529D0*t47+0.4100250709496125D0*t50))
      t73 = t7*t6+t12*t11-2.D0
      t74 = t3**2
      t75 = t74**2
      t76 = t30**2
      t77 = 1/t76
      t78 = t75*t77
      t94 = dlog(1.D0+0.32163959D2/(0.1345791371439445D2*t43+0.563098414
     &9097876D1*t39+0.2915214714219177D1*t47+0.5160664645478634D0*t50))
      t104 = 1/t22
      t108 = dexp(-0.1884711471986759D2*(-t58+0.37995525D-1*(0.101077332
     &9762878D0*t39+1.D0)*t69*t73*(1.D0-1.D0*t78)+0.1923661050931536D1*(
     &-0.310907D-1*(0.186690969707574D0*t39+1.D0)*t94+t58)*t73*t78)/t17*
     &t18*t104)
      t109 = t108-1.D0
      t110 = 1/t109
      t111 = t18*PI*t23*t110
      t113 = GAA+GBB+2.D0*GAB
      t114 = t16**2
      t115 = 1/t114
      t117 = t27**2
      t118 = 1/t117
      t119 = t118*t77
      t120 = t113*t115*t119
      t125 = t18*t23*t110
      t126 = t113*t25
      t127 = t28*t31
      t131 = t18**2
      t133 = t109**2
      t135 = t131*t104/t133
      t136 = t113**2
      t138 = t136*t115*t119
      t141 = 1.D0+0.7981753082738971D-1*t125*t126*t127+0.637083822465036
     &4D-2*t135*t138
      t142 = 1/t141
      t152 = 0.4333507964691467D-1*t126*t28*PI*t31+0.3458899056D-2*t111*
     &t138
      t153 = t141**2
      t188 = t21*(0.1D-2*(0.2568D1+0.2113856385641628D2*t39+0.6099485110
     &520599D-2*t50)/(1.D0+0.7925371465637377D1*t39+0.3896274153695659D0
     &*t50+0.554175D-1/PI*t4)-0.1853571429D-2)
      t194 = dexp(-0.120187464192284D2*t16*t118*t113*t31)
      t206 = t1*(0.5305851931277703D-1*t17*t19*t22*(0.1841868792121598D1
     &*t24*(0.4333507964691467D-1*t29*PI*t31+0.6917798112D-2*t111*t120)*
     &t142-0.1841868792121598D1*t24*t152/t153*(0.7981753082738971D-1*t12
     &5*t29*t31+0.1274167644930073D-1*t135*t120))/(1.D0+0.18418687921215
     &98D1*t24*t152*t142)+t188*t15*t127*t194-0.120187464192284D2*t188*t1
     &7*t113*t19/t76/t1*t194)
      ID_GAA_POS=D1VARS(ID_GAA)
      D1F(i, ID_GAA_POS) = D1F(i, ID_GAA_POS) +      t206 
      t1 = RA+RB
      t3 = RA-1.D0*RB
      t4 = 1/t1
      t5 = t3*t4
      t6 = t5+1.D0
      t7 = t6**(1.D0/3.D0)
      t8 = t7**2
      t11 = 1.D0-1.D0*t5
      t12 = t11**(1.D0/3.D0)
      t13 = t12**2
      t15 = 0.5D0*t8+0.5D0*t13
      t16 = t15**2
      t17 = t16*t15
      t18 = PI**2
      t19 = 1/t18
      t21 = t18**(1.D0/3.D0)
      t22 = t21**2
      t23 = 1/t21
      t24 = PI*t23
      t25 = 1/t16
      t27 = (t18*t1)**(1.D0/3.D0)
      t28 = 1/t27
      t29 = t25*t28
      t30 = t1**2
      t31 = 1/t30
      t37 = PI*t1
      t38 = t37**(1.D0/3.D0)
      t39 = 1/t38
      t42 = t37**(1.D0/6.D0)
      t43 = 1/t42
      t46 = dsqrt(t37)
      t47 = 1/t46
      t49 = t38**2
      t50 = 1/t49
      t56 = dlog(1.D0+0.160819795D2/(0.7240101934316831D1*t43+0.32595509
     &19422292D1*t39+0.1418722816479667D1*t47+0.4069130045175293D0*t50))
      t58 = 0.621814D-1*(0.1941593353441141D0*t39+1.D0)*t56
      t69 = dlog(1.D0+0.2960874998D2/(0.9872129722569272D1*t43+0.3291804
     &809945063D1*t39+0.76232752193529D0*t47+0.4100250709496125D0*t50))
      t73 = t7*t6+t12*t11-2.D0
      t74 = t3**2
      t75 = t74**2
      t76 = t30**2
      t77 = 1/t76
      t78 = t75*t77
      t94 = dlog(1.D0+0.32163959D2/(0.1345791371439445D2*t43+0.563098414
     &9097876D1*t39+0.2915214714219177D1*t47+0.5160664645478634D0*t50))
      t104 = 1/t22
      t108 = dexp(-0.1884711471986759D2*(-t58+0.37995525D-1*(0.101077332
     &9762878D0*t39+1.D0)*t69*t73*(1.D0-1.D0*t78)+0.1923661050931536D1*(
     &-0.310907D-1*(0.186690969707574D0*t39+1.D0)*t94+t58)*t73*t78)/t17*
     &t18*t104)
      t109 = t108-1.D0
      t110 = 1/t109
      t111 = t18*PI*t23*t110
      t113 = GAA+GBB+2.D0*GAB
      t114 = t16**2
      t115 = 1/t114
      t117 = t27**2
      t118 = 1/t117
      t119 = t118*t77
      t120 = t113*t115*t119
      t125 = t18*t23*t110
      t126 = t113*t25
      t127 = t28*t31
      t131 = t18**2
      t133 = t109**2
      t135 = t131*t104/t133
      t136 = t113**2
      t138 = t136*t115*t119
      t141 = 1.D0+0.7981753082738971D-1*t125*t126*t127+0.637083822465036
     &4D-2*t135*t138
      t142 = 1/t141
      t152 = 0.4333507964691467D-1*t126*t28*PI*t31+0.3458899056D-2*t111*
     &t138
      t153 = t141**2
      t188 = t21*(0.1D-2*(0.2568D1+0.2113856385641628D2*t39+0.6099485110
     &520599D-2*t50)/(1.D0+0.7925371465637377D1*t39+0.3896274153695659D0
     &*t50+0.554175D-1/PI*t4)-0.1853571429D-2)
      t194 = dexp(-0.120187464192284D2*t16*t118*t113*t31)
      t206 = t1*(0.5305851931277703D-1*t17*t19*t22*(0.1841868792121598D1
     &*t24*(0.4333507964691467D-1*t29*PI*t31+0.6917798112D-2*t111*t120)*
     &t142-0.1841868792121598D1*t24*t152/t153*(0.7981753082738971D-1*t12
     &5*t29*t31+0.1274167644930073D-1*t135*t120))/(1.D0+0.18418687921215
     &98D1*t24*t152*t142)+t188*t15*t127*t194-0.120187464192284D2*t188*t1
     &7*t113*t19/t76/t1*t194)
      ID_GBB_POS=D1VARS(ID_GBB)
      D1F(i, ID_GBB_POS) = D1F(i, ID_GBB_POS) +      t206 
      t1 = RA+RB
      t3 = RA-1.D0*RB
      t4 = 1/t1
      t5 = t3*t4
      t6 = t5+1.D0
      t7 = t6**(1.D0/3.D0)
      t8 = t7**2
      t11 = 1.D0-1.D0*t5
      t12 = t11**(1.D0/3.D0)
      t13 = t12**2
      t15 = 0.5D0*t8+0.5D0*t13
      t16 = t15**2
      t17 = t16*t15
      t18 = PI**2
      t19 = 1/t18
      t21 = t18**(1.D0/3.D0)
      t22 = t21**2
      t23 = 1/t21
      t24 = PI*t23
      t25 = 1/t16
      t27 = (t18*t1)**(1.D0/3.D0)
      t28 = 1/t27
      t29 = t25*t28
      t30 = t1**2
      t31 = 1/t30
      t37 = PI*t1
      t38 = t37**(1.D0/3.D0)
      t39 = 1/t38
      t42 = t37**(1.D0/6.D0)
      t43 = 1/t42
      t46 = dsqrt(t37)
      t47 = 1/t46
      t49 = t38**2
      t50 = 1/t49
      t56 = dlog(1.D0+0.160819795D2/(0.7240101934316831D1*t43+0.32595509
     &19422292D1*t39+0.1418722816479667D1*t47+0.4069130045175293D0*t50))
      t58 = 0.621814D-1*(0.1941593353441141D0*t39+1.D0)*t56
      t69 = dlog(1.D0+0.2960874998D2/(0.9872129722569272D1*t43+0.3291804
     &809945063D1*t39+0.76232752193529D0*t47+0.4100250709496125D0*t50))
      t73 = t7*t6+t12*t11-2.D0
      t74 = t3**2
      t75 = t74**2
      t76 = t30**2
      t77 = 1/t76
      t78 = t75*t77
      t94 = dlog(1.D0+0.32163959D2/(0.1345791371439445D2*t43+0.563098414
     &9097876D1*t39+0.2915214714219177D1*t47+0.5160664645478634D0*t50))
      t104 = 1/t22
      t108 = dexp(-0.1884711471986759D2*(-t58+0.37995525D-1*(0.101077332
     &9762878D0*t39+1.D0)*t69*t73*(1.D0-1.D0*t78)+0.1923661050931536D1*(
     &-0.310907D-1*(0.186690969707574D0*t39+1.D0)*t94+t58)*t73*t78)/t17*
     &t18*t104)
      t109 = t108-1.D0
      t110 = 1/t109
      t111 = t18*PI*t23*t110
      t113 = GAA+GBB+2.D0*GAB
      t114 = t16**2
      t115 = 1/t114
      t117 = t27**2
      t118 = 1/t117
      t119 = t118*t77
      t120 = t113*t115*t119
      t125 = t18*t23*t110
      t126 = t113*t25
      t127 = t28*t31
      t131 = t18**2
      t133 = t109**2
      t135 = t131*t104/t133
      t136 = t113**2
      t138 = t136*t115*t119
      t141 = 1.D0+0.7981753082738971D-1*t125*t126*t127+0.637083822465036
     &4D-2*t135*t138
      t142 = 1/t141
      t152 = 0.4333507964691467D-1*t126*t28*PI*t31+0.3458899056D-2*t111*
     &t138
      t153 = t141**2
      t188 = t21*(0.1D-2*(0.2568D1+0.2113856385641628D2*t39+0.6099485110
     &520599D-2*t50)/(1.D0+0.7925371465637377D1*t39+0.3896274153695659D0
     &*t50+0.554175D-1/PI*t4)-0.1853571429D-2)
      t194 = dexp(-0.120187464192284D2*t16*t118*t113*t31)
      t207 = t1*(0.5305851931277703D-1*t17*t19*t22*(0.1841868792121598D1
     &*t24*(0.8667015929382934D-1*t29*PI*t31+0.13835596224D-1*t111*t120)
     &*t142-0.1841868792121598D1*t24*t152/t153*(0.1596350616547794D0*t12
     &5*t29*t31+0.2548335289860146D-1*t135*t120))/(1.D0+0.18418687921215
     &98D1*t24*t152*t142)+2.D0*t188*t15*t127*t194-0.2403749283845681D2*t
     &188*t17*t113*t19/t76/t1*t194)
      ID_GAB_POS=D1VARS(ID_GAB)
      D1F(i, ID_GAB_POS) = D1F(i, ID_GAB_POS) +      t207 
      END IF
      ELSE IF (RA.GT.TOL .AND. RB.LE.TOL) THEN
      t1 = PI*RA
      t2 = t1**(1.D0/3.D0)
      t3 = 1/t2
      t6 = t1**(1.D0/6.D0)
      t10 = dsqrt(t1)
      t13 = t2**2
      t14 = 1/t13
      t20 = dlog(1.D0+0.32163959D2/(0.1345791371439445D2/t6+0.5630984149
     &097876D1*t3+0.2915214714219177D1/t10+0.5160664645478634D0*t14))
      t21 = (0.186690969707574D0*t3+1.D0)*t20
      t23 = PI**2
      t25 = t23**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t25
      t31 = (t23*RA)**(1.D0/3.D0)
      t32 = 1/t31
      t33 = GAA*t32
      t34 = RA**2
      t35 = 1/t34
      t41 = 1/t26
      t45 = dexp(0.117193997914149D1*t21*t23*t41)
      t46 = t45-1.D0
      t47 = 1/t46
      t49 = GAA**2
      t50 = t31**2
      t51 = 1/t50
      t53 = t34**2
      t55 = t49*t51/t53
      t64 = t23**2
      t66 = t46**2
      t77 = dlog(1.D0+0.1841868792121598D1*PI*t28*(0.6879015101863806D-1
     &*t33*PI*t35+0.8715879456452048D-2*t23*PI*t28*t47*t55)/(1.D0+0.1267
     &024324009026D0*t23*t28*t47*t33*t35+0.1605350636680301D-1*t64*t41/t
     &66*t55))
      t100 = dexp(-0.7571335803467249D1*t51*GAA*t35)
      t105 = RA*(-0.310907D-1*t21+0.2652925965638851D-1/t23*t26*t77+0.79
     &37005259840997D0*t25*(0.1D-2*(0.2568D1+0.2113856385641628D2*t3+0.6
     &099485110520599D-2*t14)/(1.D0+0.7925371465637377D1*t3+0.3896274153
     &695659D0*t14+0.554175D-1/PI/RA)-0.1853571429D-2)*GAA*t32*t35*t100)
      F(i) = F(i) +      t105 
      IF (IDERIV .GE. 1) THEN
      t1 = PI*RA
      t2 = t1**(1.D0/3.D0)
      t3 = 1/t2
      t5 = 0.186690969707574D0*t3+1.D0
      t6 = t1**(1.D0/6.D0)
      t10 = dsqrt(t1)
      t13 = t2**2
      t14 = 1/t13
      t16 = 0.1345791371439445D2/t6+0.5630984149097876D1*t3+0.2915214714
     &219177D1/t10+0.5160664645478634D0*t14
      t19 = 1.D0+0.32163959D2/t16
      t20 = dlog(t19)
      t21 = t5*t20
      t23 = PI**2
      t25 = t23**(1.D0/3.D0)
      t26 = t25**2
      t27 = 1/t23*t26
      t28 = 1/t25
      t29 = PI*t28
      t30 = t23*RA
      t31 = t30**(1.D0/3.D0)
      t32 = 1/t31
      t33 = GAA*t32
      t34 = RA**2
      t35 = 1/t34
      t39 = t23*PI
      t40 = t39*t28
      t41 = 1/t26
      t45 = dexp(0.117193997914149D1*t21*t23*t41)
      t46 = t45-1.D0
      t47 = 1/t46
      t48 = t40*t47
      t49 = GAA**2
      t50 = t31**2
      t51 = 1/t50
      t52 = t49*t51
      t53 = t34**2
      t54 = 1/t53
      t55 = t52*t54
      t58 = 0.6879015101863806D-1*t33*PI*t35+0.8715879456452048D-2*t48*t
     &55
      t59 = t23*t28
      t60 = t59*t47
      t64 = t23**2
      t65 = t64*t41
      t66 = t46**2
      t67 = 1/t66
      t68 = t65*t67
      t71 = 1.D0+0.1267024324009026D0*t60*t33*t35+0.1605350636680301D-1*
     &t68*t55
      t72 = 1/t71
      t76 = 1.D0+0.1841868792121598D1*t29*t58*t72
      t77 = dlog(t76)
      t82 = 0.2568D1+0.2113856385641628D2*t3+0.6099485110520599D-2*t14
      t85 = 1/PI
      t89 = 1.D0+0.7925371465637377D1*t3+0.3896274153695659D0*t14+0.5541
     &75D-1*t85/RA
      t90 = 1/t89
      t95 = t25*(0.1D-2*t82*t90-0.1853571429D-2)*GAA
      t96 = t32*t35
      t97 = t51*GAA
      t100 = dexp(-0.7571335803467249D1*t97*t35)
      t101 = t96*t100
      t105 = 1/t2/t1
      t106 = t105*PI
      t109 = t16**2
      t111 = t5/t109
      t117 = t10**2
      t124 = 1/t13/t1*PI
      t126 = -0.2242985619065741D1/t6/t1*PI-0.1876994716365959D1*t106-0.
     &1457607357109589D1/t117/t10*PI-0.3440443096985756D0*t124
      t127 = 1/t19
      t132 = 1/t31/t30
      t133 = GAA*t132
      t138 = 1/t34/RA
      t155 = (-0.7293020371499964D-1*t105*t39*t20*t41-0.3769422943956775
     &D2*t111*t126*t127*t23*t41)*t45
      t156 = t51*t54*t155
      t163 = 1/t50/t30
      t165 = t49*t163*t54
      t170 = t52/t53/RA
      t177 = t71**2
      t220 = t89**2
      s1 = -0.310907D-1*t21+0.2652925965638851D-1*t27*t77
      s2 = s1
      s4 = 0.7937005259840997D0*t95*t101
      s6 = RA
      s8 = 0.1934784310629091D-2*t106*t20+0.10000000000813D1*t111*t126*t
     &127+0.2652925965638851D-1*t27*(0.1841868792121598D1*t29*(-0.229300
     &5033954602D-1*t133*t39*t35-0.1375803020372761D0*t33*PI*t138-0.8715
     &879456452048D-2*t40*t67*t49*t156-0.5810586304301365D-2*t64*PI*t28*
     &t47*t165-0.3486351782580819D-1*t48*t170)*t72-0.1841868792121598D1*
     &t29*t58/t177*(-0.1267024324009026D0*t59*t67*GAA*t96*t155-0.4223414
     &413363421D-1*t64*t28*t47*t133*t35-0.2534048648018052D0*t60*t33*t13
     &8-0.3210701273360602D-1*t65/t66/t46*t49*t156-0.1070233757786867D-1
     &*t64*t23*t41*t67*t165-0.6421402546721205D-1*t68*t170))/t76
      s7 = s8+0.7937005259840997D0*t25*(0.1D-2*(-0.704618795213876D1*t10
     &6-0.4066323407013733D-2*t124)*t90-0.1D-2*t82/t220*(-0.264179048854
     &5792D1*t106-0.2597516102463773D0*t124-0.554175D-1*t85*t35))*GAA*t1
     &01-0.2645668419946999D0*t95*t132*t35*t100*t23-0.1587401051968199D1
     &*t95*t32*t138*t100+0.7937005259840997D0*t95*t96*(0.504755720231149
     &9D1*t163*GAA*t35*t23+0.151426716069345D2*t97*t138)*t100
      s5 = s6*s7
      s3 = s4+s5
      t257 = s2+s3
      ID_RA_POS=D1VARS(ID_RA)
      D1F(i, ID_RA_POS) = D1F(i, ID_RA_POS) +      t257 
      t1 = PI**2
      t2 = 1/t1
      t3 = t1**(1.D0/3.D0)
      t4 = t3**2
      t6 = 1/t3
      t7 = PI*t6
      t9 = (t1*RA)**(1.D0/3.D0)
      t10 = 1/t9
      t12 = RA**2
      t13 = 1/t12
      t18 = PI*RA
      t19 = t18**(1.D0/3.D0)
      t20 = 1/t19
      t23 = t18**(1.D0/6.D0)
      t27 = dsqrt(t18)
      t30 = t19**2
      t31 = 1/t30
      t37 = dlog(1.D0+0.32163959D2/(0.1345791371439445D2/t23+0.563098414
     &9097876D1*t20+0.2915214714219177D1/t27+0.5160664645478634D0*t31))
      t39 = 1/t4
      t43 = dexp(0.117193997914149D1*(0.186690969707574D0*t20+1.D0)*t37*
     &t1*t39)
      t44 = t43-1.D0
      t45 = 1/t44
      t46 = t1*PI*t6*t45
      t47 = t9**2
      t48 = 1/t47
      t49 = GAA*t48
      t50 = t12**2
      t51 = 1/t50
      t52 = t49*t51
      t56 = t6*t1
      t58 = GAA*t10
      t62 = t1**2
      t64 = t44**2
      t66 = t62*t39/t64
      t67 = GAA**2
      t69 = t67*t48*t51
      t72 = 1.D0+0.1267024324009026D0*t56*t45*t58*t13+0.1605350636680301
     &D-1*t66*t69
      t73 = 1/t72
      t82 = 0.6879015101863806D-1*t58*PI*t13+0.8715879456452048D-2*t46*t
     &69
      t83 = t72**2
      t119 = t3*(0.1D-2*(0.2568D1+0.2113856385641628D2*t20+0.60994851105
     &20599D-2*t31)/(1.D0+0.7925371465637377D1*t20+0.3896274153695659D0*
     &t31+0.554175D-1/PI/RA)-0.1853571429D-2)
      t123 = dexp(-0.7571335803467249D1*t49*t13)
      t135 = RA*(0.2652925965638851D-1*t2*t4*(0.1841868792121598D1*t7*(0
     &.6879015101863806D-1*t10*PI*t13+0.174317589129041D-1*t46*t52)*t73-
     &0.1841868792121598D1*t7*t82/t83*(0.1267024324009026D0*t56*t45*t10*
     &t13+0.3210701273360602D-1*t66*t52))/(1.D0+0.1841868792121598D1*t7*
     &t82*t73)+0.7937005259840997D0*t119*t10*t13*t123-0.6009373209614202
     &D1*t119*GAA*t2/t50/RA*t123)
      ID_GAA_POS=D1VARS(ID_GAA)
      D1F(i, ID_GAA_POS) = D1F(i, ID_GAA_POS) +      t135 
      END IF
      ELSE IF (RA.LE.TOL .AND. RB.GT.TOL) THEN
      t1 = PI*RB
      t2 = t1**(1.D0/3.D0)
      t3 = 1/t2
      t6 = t1**(1.D0/6.D0)
      t10 = dsqrt(t1)
      t13 = t2**2
      t14 = 1/t13
      t20 = dlog(1.D0+0.32163959D2/(0.1345791371439445D2/t6+0.5630984149
     &097876D1*t3+0.2915214714219177D1/t10+0.5160664645478634D0*t14))
      t21 = (0.186690969707574D0*t3+1.D0)*t20
      t23 = PI**2
      t25 = t23**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t25
      t31 = (t23*RB)**(1.D0/3.D0)
      t32 = 1/t31
      t33 = GBB*t32
      t34 = RB**2
      t35 = 1/t34
      t41 = 1/t26
      t45 = dexp(0.117193997914149D1*t21*t23*t41)
      t46 = t45-1.D0
      t47 = 1/t46
      t49 = GBB**2
      t50 = t31**2
      t51 = 1/t50
      t53 = t34**2
      t55 = t49*t51/t53
      t64 = t23**2
      t66 = t46**2
      t77 = dlog(1.D0+0.1841868792121598D1*PI*t28*(0.6879015101863806D-1
     &*t33*PI*t35+0.8715879456452048D-2*t23*PI*t28*t47*t55)/(1.D0+0.1267
     &024324009026D0*t23*t28*t47*t33*t35+0.1605350636680301D-1*t64*t41/t
     &66*t55))
      t100 = dexp(-0.7571335803467249D1*t51*GBB*t35)
      t105 = RB*(-0.310907D-1*t21+0.2652925965638851D-1/t23*t26*t77+0.79
     &37005259840997D0*t25*(0.1D-2*(0.2568D1+0.2113856385641628D2*t3+0.6
     &099485110520599D-2*t14)/(1.D0+0.7925371465637377D1*t3+0.3896274153
     &695659D0*t14+0.554175D-1/PI/RB)-0.1853571429D-2)*GBB*t32*t35*t100)
      F(i) = F(i) +      t105 
      IF (IDERIV .GE. 1) THEN
      t1 = PI*RB
      t2 = t1**(1.D0/3.D0)
      t3 = 1/t2
      t5 = 0.186690969707574D0*t3+1.D0
      t6 = t1**(1.D0/6.D0)
      t10 = dsqrt(t1)
      t13 = t2**2
      t14 = 1/t13
      t16 = 0.1345791371439445D2/t6+0.5630984149097876D1*t3+0.2915214714
     &219177D1/t10+0.5160664645478634D0*t14
      t19 = 1.D0+0.32163959D2/t16
      t20 = dlog(t19)
      t21 = t5*t20
      t23 = PI**2
      t25 = t23**(1.D0/3.D0)
      t26 = t25**2
      t27 = 1/t23*t26
      t28 = 1/t25
      t29 = PI*t28
      t30 = t23*RB
      t31 = t30**(1.D0/3.D0)
      t32 = 1/t31
      t33 = GBB*t32
      t34 = RB**2
      t35 = 1/t34
      t39 = t23*PI
      t40 = t39*t28
      t41 = 1/t26
      t45 = dexp(0.117193997914149D1*t21*t23*t41)
      t46 = t45-1.D0
      t47 = 1/t46
      t48 = t40*t47
      t49 = GBB**2
      t50 = t31**2
      t51 = 1/t50
      t52 = t49*t51
      t53 = t34**2
      t54 = 1/t53
      t55 = t52*t54
      t58 = 0.6879015101863806D-1*t33*PI*t35+0.8715879456452048D-2*t48*t
     &55
      t59 = t23*t28
      t60 = t59*t47
      t64 = t23**2
      t65 = t64*t41
      t66 = t46**2
      t67 = 1/t66
      t68 = t65*t67
      t71 = 1.D0+0.1267024324009026D0*t60*t33*t35+0.1605350636680301D-1*
     &t68*t55
      t72 = 1/t71
      t76 = 1.D0+0.1841868792121598D1*t29*t58*t72
      t77 = dlog(t76)
      t82 = 0.2568D1+0.2113856385641628D2*t3+0.6099485110520599D-2*t14
      t85 = 1/PI
      t89 = 1.D0+0.7925371465637377D1*t3+0.3896274153695659D0*t14+0.5541
     &75D-1*t85/RB
      t90 = 1/t89
      t95 = t25*(0.1D-2*t82*t90-0.1853571429D-2)*GBB
      t96 = t32*t35
      t97 = t51*GBB
      t100 = dexp(-0.7571335803467249D1*t97*t35)
      t101 = t96*t100
      t105 = 1/t2/t1
      t106 = t105*PI
      t109 = t16**2
      t111 = t5/t109
      t117 = t10**2
      t124 = 1/t13/t1*PI
      t126 = -0.2242985619065741D1/t6/t1*PI-0.1876994716365959D1*t106-0.
     &1457607357109589D1/t117/t10*PI-0.3440443096985756D0*t124
      t127 = 1/t19
      t132 = 1/t31/t30
      t133 = GBB*t132
      t138 = 1/t34/RB
      t155 = (-0.7293020371499964D-1*t105*t39*t20*t41-0.3769422943956775
     &D2*t111*t126*t127*t23*t41)*t45
      t156 = t51*t54*t155
      t163 = 1/t50/t30
      t165 = t49*t163*t54
      t170 = t52/t53/RB
      t177 = t71**2
      t220 = t89**2
      s1 = -0.310907D-1*t21+0.2652925965638851D-1*t27*t77
      s2 = s1
      s4 = 0.7937005259840997D0*t95*t101
      s6 = RB
      s8 = 0.1934784310629091D-2*t106*t20+0.10000000000813D1*t111*t126*t
     &127+0.2652925965638851D-1*t27*(0.1841868792121598D1*t29*(-0.229300
     &5033954602D-1*t133*t39*t35-0.1375803020372761D0*t33*PI*t138-0.8715
     &879456452048D-2*t40*t67*t49*t156-0.5810586304301365D-2*t64*PI*t28*
     &t47*t165-0.3486351782580819D-1*t48*t170)*t72-0.1841868792121598D1*
     &t29*t58/t177*(-0.1267024324009026D0*t59*t67*GBB*t96*t155-0.4223414
     &413363421D-1*t64*t28*t47*t133*t35-0.2534048648018052D0*t60*t33*t13
     &8-0.3210701273360602D-1*t65/t66/t46*t49*t156-0.1070233757786867D-1
     &*t64*t23*t41*t67*t165-0.6421402546721205D-1*t68*t170))/t76
      s7 = s8+0.7937005259840997D0*t25*(0.1D-2*(-0.704618795213876D1*t10
     &6-0.4066323407013733D-2*t124)*t90-0.1D-2*t82/t220*(-0.264179048854
     &5792D1*t106-0.2597516102463773D0*t124-0.554175D-1*t85*t35))*GBB*t1
     &01-0.2645668419946999D0*t95*t132*t35*t100*t23-0.1587401051968199D1
     &*t95*t32*t138*t100+0.7937005259840997D0*t95*t96*(0.504755720231149
     &9D1*t163*GBB*t35*t23+0.151426716069345D2*t97*t138)*t100
      s5 = s6*s7
      s3 = s4+s5
      t257 = s2+s3
      ID_RB_POS=D1VARS(ID_RB)
      D1F(i, ID_RB_POS) = D1F(i, ID_RB_POS) +      t257 
      t1 = PI**2
      t2 = 1/t1
      t3 = t1**(1.D0/3.D0)
      t4 = t3**2
      t6 = 1/t3
      t7 = PI*t6
      t9 = (t1*RB)**(1.D0/3.D0)
      t10 = 1/t9
      t12 = RB**2
      t13 = 1/t12
      t18 = PI*RB
      t19 = t18**(1.D0/3.D0)
      t20 = 1/t19
      t23 = t18**(1.D0/6.D0)
      t27 = dsqrt(t18)
      t30 = t19**2
      t31 = 1/t30
      t37 = dlog(1.D0+0.32163959D2/(0.1345791371439445D2/t23+0.563098414
     &9097876D1*t20+0.2915214714219177D1/t27+0.5160664645478634D0*t31))
      t39 = 1/t4
      t43 = dexp(0.117193997914149D1*(0.186690969707574D0*t20+1.D0)*t37*
     &t1*t39)
      t44 = t43-1.D0
      t45 = 1/t44
      t46 = t1*PI*t6*t45
      t47 = t9**2
      t48 = 1/t47
      t49 = GBB*t48
      t50 = t12**2
      t51 = 1/t50
      t52 = t49*t51
      t56 = t6*t1
      t58 = GBB*t10
      t62 = t1**2
      t64 = t44**2
      t66 = t62*t39/t64
      t67 = GBB**2
      t69 = t67*t48*t51
      t72 = 1.D0+0.1267024324009026D0*t56*t45*t58*t13+0.1605350636680301
     &D-1*t66*t69
      t73 = 1/t72
      t82 = 0.6879015101863806D-1*t58*PI*t13+0.8715879456452048D-2*t46*t
     &69
      t83 = t72**2
      t119 = t3*(0.1D-2*(0.2568D1+0.2113856385641628D2*t20+0.60994851105
     &20599D-2*t31)/(1.D0+0.7925371465637377D1*t20+0.3896274153695659D0*
     &t31+0.554175D-1/PI/RB)-0.1853571429D-2)
      t123 = dexp(-0.7571335803467249D1*t49*t13)
      t135 = RB*(0.2652925965638851D-1*t2*t4*(0.1841868792121598D1*t7*(0
     &.6879015101863806D-1*t10*PI*t13+0.174317589129041D-1*t46*t52)*t73-
     &0.1841868792121598D1*t7*t82/t83*(0.1267024324009026D0*t56*t45*t10*
     &t13+0.3210701273360602D-1*t66*t52))/(1.D0+0.1841868792121598D1*t7*
     &t82*t73)+0.7937005259840997D0*t119*t10*t13*t123-0.6009373209614202
     &D1*t119*GBB*t2/t50/RB*t123)
      ID_GBB_POS=D1VARS(ID_GBB)
      D1F(i, ID_GBB_POS) = D1F(i, ID_GBB_POS) +      t135 
      END IF
      END IF
      END DO
      RETURN
      END
                   
                   
                   
                   
