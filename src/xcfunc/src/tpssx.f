!--------------------------------------------------------------------------
!                 Reference section for the functional:
!--------------------------------------------------------------------------
! This is the exchange part for TPSS functional
! "Climbing the density functional ladder: Nonempirical 
!  meta-generalized gradient approximation designed for 
!  molecules and solids"
!  J. M. Tao, J. P. Perdew, V. N. Staroverov, and G. E. Scuseria
!  Phys. Rev. Lett., 91 (2003) 146401
!
!  note:
!
!  the TPSS exchange functional uses the small tau variable. Here in the 
!  corresponding maple file we already handled this. For the pointwise
!  calculation (tpssx_pw.f) the same.
!
!

      subroutine functional_tpssx
     &(INFOR,NG,NDEN,TOL,rhoA,rhoB,DRhoA,DRhoB,TauA,TauB,F,D1F)
      IMPLICIT NONE
!--------------------------------------------------------
! This routine is used to calculate the functional and
! functional derivatives values up to the third order.
! It's only the interface function, the real calculation
! work will be done by seperate routine.
! INPUT :
! NG    : the number of grid points
! rhoA  : the alpha electron density
! rhoB  : the beta  electron density
! DRhoA : the alpha rho'
! DRhoB : the beta  rho'
! TauA  : the alpha kinetic energy density
! TauB  : the beta  kinetic energy density
! LapA  : the alpha laplacian density
! LapB  : the beta  laplacian density
! OUTPUT:
! F     : functional values
! D1F   : the first  order functional derivatives
!--------------------------------------------------------
      INTEGER NG
      INTEGER NDEN ! number of density
      INTEGER INFOR(*)
      DOUBLE PRECISION rhoA(NG),rhoB(NG)
      DOUBLE PRECISION DRhoA(NG,3),DRhoB(NG,3)
      DOUBLE PRECISION TauA(NG),TauB(NG)
      DOUBLE PRECISION F(NG), D1F(NG,*)
      DOUBLE PRECISION TOL
      
      IF (NDEN .EQ. 1) THEN 
         CALL functional_tpssx_close(INFOR,NG,TOL,rhoA,DRhoA,TauA,F,D1F)
      ELSE  
         CALL functional_tpssx_open(INFOR,NG,TOL,rhoA,rhoB,DRhoA,DRhoB,
     &TauA,TauB,F,D1F)
      END IF  
      RETURN  
      END     

      subroutine functional_tpssx_close
     &(INFOR,NG,TOL,rhoA,DRhoA,TauA,F,D1F)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
!--------------------------------------------------------
! This routine is used to calculate the functional and
! functional derivatives values up to the third order.
! We note that this routine is used in the close shell case,
! that means, we have RA=RB, GAA=GAB=GBB,TA=TB and LA=LB
! for each grid point.
!--------------------------------------------------------
#include "fderiv1.inc"
      INTEGER INFOR(*)
      INTEGER  D1VARS(N_FUNC_DERIV_1)
      INTEGER  ID_RA_POS, ID_GAA_POS, ID_GAB_POS, ID_TA_POS
      INTEGER  ID_RB_POS, ID_GBB_POS, ID_TB_POS
      INTEGER NG, I
      DOUBLE PRECISION rhoA(NG)
      DOUBLE PRECISION RA, RB ! rho vaule at each point
      DOUBLE PRECISION DRhoA(NG,3)
      DOUBLE PRECISION GAA, GAB, GBB ! the gamma value at each point
      DOUBLE PRECISION TauA(NG)
      DOUBLE PRECISION TA, TB     ! the tau value at each point
      DOUBLE PRECISION F(NG),D1F(NG,*)
      DOUBLE PRECISION TOL ! tolerance
      DOUBLE PRECISION PI
      
      ! firstly initilize variable position information
      CALL INIT_FUNC_DERIV_1(INFOR,D1VARS)
      ID_RA_POS  = D1VARS(ID_RA)
      ID_RB_POS  = D1VARS(ID_RB)
      ID_GAA_POS = D1VARS(ID_GAA)
      ID_GAB_POS = D1VARS(ID_GAB)
      ID_GBB_POS = D1VARS(ID_GBB)
      ID_TA_POS  = D1VARS(ID_TA)
      ID_TB_POS  = D1VARS(ID_TB)
      
      ! deal with the constants
      PI = 4.D0*DATAN(1.D0)

      ! the real calculation begins
      DO i = 1,NG
      RA = rhoA(i)
      RB = RA 
      IF (RA.LE.TOL) CYCLE
      GAA = DRhoA(i,1)*DRhoA(i,1) + DRhoA(i,2)*DRhoA(i,2)
     &+ DRhoA(i,3)*DRhoA(i,3)
      GBB = GAA
      GAB = GAA
      TA = TauA(i)
      TB = TA
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t5 = 1/PI
      t6 = GAA**2
      t7 = RA**2
      t9 = t6/t7
      t10 = TA**2
      t11 = 1/t10
      t12 = t9*t11
      t15 = (1.D0+0.625D-1*t12)**2
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RA**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t32 = GAA*t24
      t38 = t28*(4.D0/GAA*RA*TA-1.D0)
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t50 = t32*t28
      t52 = 0.45D0*t41/t46+0.5047557202311499D-1*t50
      t53 = t52**2
      t57 = 1/t22/t1
      t59 = t7**2
      t63 = t6*t57/t25/t59/RA
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t72 = t1**2
      t73 = 1/t72
      t75 = t59**2
      t82 = (1.D0+0.9386624443156864D-1*t50)**2
      t94 = (t1*RB)**(1.D0/3.D0)
      t96 = GBB**2
      t97 = RB**2
      t99 = t96/t97
      t100 = TB**2
      t101 = 1/t100
      t102 = t99*t101
      t105 = (1.D0+0.625D-1*t102)**2
      t112 = RB**(1.D0/3.D0)
      t113 = t112**2
      t115 = 1/t113/t97
      t119 = GBB*t24
      t125 = t115*(4.D0/GBB*RB*TB-1.D0)
      t128 = 0.1261889300577875D0*t119*t125-1.D0
      t133 = dsqrt(1.D0+0.5047557202715304D-1*t119*t125*t128)
      t137 = t119*t115
      t139 = 0.45D0*t128/t133+0.5047557202311499D-1*t137
      t140 = t139**2
      t144 = t97**2
      t148 = t96*t57/t112/t144/RB
      t151 = dsqrt(0.1125D-1*t102+0.2866256292443252D-2*t148)
      t158 = t144**2
      t165 = (1.D0+0.9386624443156864D-1*t137)**2
      t176 = -0.1362840444624105D1*RA*t3*t5*(0.1804D1-0.804D0/(1.D0+0.12
     &43781095D1*(0.7571335803467249D-1*(0.1234567901234568D0+0.99435D-1
     &*t9*t11/t15)*GAA*t24*t28+0.7209876543209877D-1*t53-0.1802469135802
     &469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D-2*t12+0.146435
     &2735D-3*t6*GAA*t73/t75)/t82))-0.1362840444624105D1*RB*t94*t5*(0.18
     &04D1-0.804D0/(1.D0+0.1243781095D1*(0.7571335803467249D-1*(0.123456
     &7901234568D0+0.99435D-1*t99*t101/t105)*GBB*t24*t115+0.720987654320
     &9877D-1*t140-0.1802469135802469D0*t139*t151+0.10867231795124D-3*t1
     &48+0.6887544672D-2*t102+0.1464352735D-3*t96*GBB*t73/t158)/t165))
       F(i) = F(i) +      t176 

      ! derivative
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t4 = 1/PI
      t6 = GAA**2
      t7 = RA**2
      t9 = t6/t7
      t10 = TA**2
      t11 = 1/t10
      t12 = t9*t11
      t14 = 1.D0+0.625D-1*t12
      t15 = t14**2
      t17 = t11/t15
      t21 = (0.1234567901234568D0+0.99435D-1*t9*t17)*GAA
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RA**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t29 = t24*t28
      t32 = GAA*t24
      t37 = 4.D0/GAA*RA*TA-1.D0
      t38 = t28*t37
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t47 = 1/t46
      t50 = t32*t28
      t52 = 0.45D0*t41*t47+0.5047557202311499D-1*t50
      t53 = t52**2
      t58 = t6/t22/t1
      t59 = t7**2
      t60 = t59*RA
      t63 = t58/t25/t60
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t72 = t1**2
      t74 = t6*GAA/t72
      t75 = t59**2
      t79 = 0.7571335803467249D-1*t21*t29+0.7209876543209877D-1*t53-0.18
     &02469135802469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D-2*t
     &12+0.1464352735D-3*t74/t75
      t81 = 1.D0+0.9386624443156864D-1*t50
      t82 = t81**2
      t83 = 1/t82
      t86 = 1.D0+0.1243781095D1*t79*t83
      t89 = 0.1804D1-0.804D0/t86
      t92 = t3**2
      t99 = t86**2
      t102 = t7*RA
      t104 = t6/t102
      t107 = t6**2
      t110 = t10**2
      t122 = 1/t26/t102
      t126 = t122*t37
      t131 = -0.3365038134874333D0*t32*t126+0.5047557202311499D0*t29*TA
      t134 = t46**2
      t150 = t32*t122
      t152 = 0.45D0*t131*t47-0.225D0*t41/t134/t46*(-0.1346015254057414D0
     &*t32*t126*t41+0.2019022881086121D0*t29*TA*t41+0.5047557202715304D-
     &1*t32*t38*t131)-0.1346015253949733D0*t150
      t159 = t104*t11
      t164 = t58/t25/t59/t7
      t187 = -0.1362840444624105D1*t3*t4*t89-0.4542801482080349D0*RA/t92
     &*PI*t89-0.109572371747778D1*RA*t3*t4/t99*(0.1243781095D1*(0.757133
     &5803467249D-1*(-0.19887D0*t104*t17+0.2485875D-1*t107/t60/t110/t15/
     &t14)*GAA*t29-0.20190228809246D0*t21*t24*t122+0.1441975308641975D0*
     &t52*t152-0.1802469135802469D0*t152*t66-0.9012345679012346D-1*t52/t
     &66*(-0.225D-1*t159-0.1528670022636401D-1*t164)-0.5795856957399467D
     &-3*t164-0.13775089344D-1*t159-0.1171482188D-2*t74/t75/RA)*t83+0.62
     &26616548407152D0*t79/t82/t81*t150)
       D1F(i, ID_RA_POS) = D1F(i, ID_RA_POS) +      t187 
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t6 = GAA**2
      t7 = RA**2
      t8 = 1/t7
      t9 = t6*t8
      t10 = TA**2
      t11 = 1/t10
      t12 = t9*t11
      t14 = 1.D0+0.625D-1*t12
      t15 = t14**2
      t17 = t11/t15
      t20 = 0.1234567901234568D0+0.99435D-1*t9*t17
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RA**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t29 = t24*t28
      t32 = GAA*t24
      t33 = 1/GAA
      t37 = 4.D0*t33*RA*TA-1.D0
      t38 = t28*t37
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t47 = 1/t46
      t50 = t32*t28
      t52 = 0.45D0*t41*t47+0.5047557202311499D-1*t50
      t53 = t52**2
      t57 = 1/t22/t1
      t59 = t7**2
      t62 = 1/t25/t59/RA
      t63 = t6*t57*t62
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t71 = t6*GAA
      t72 = t1**2
      t73 = 1/t72
      t75 = t59**2
      t76 = 1/t75
      t79 = 0.7571335803467249D-1*t20*GAA*t29+0.7209876543209877D-1*t53-
     &0.1802469135802469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D
     &-2*t12+0.1464352735D-3*t71*t73*t76
      t81 = 1.D0+0.9386624443156864D-1*t50
      t82 = t81**2
      t83 = 1/t82
      t87 = (1.D0+0.1243781095D1*t79*t83)**2
      t90 = GAA*t8
      t95 = t10**2
      t111 = t33*t24
      t114 = 1/t26/RA*TA
      t117 = 0.1261889300577875D0*t29*t37-0.5047557202311499D0*t111*t114
      t120 = t46**2
      t137 = 0.45D0*t117*t47-0.225D0*t41/t120/t46*(0.5047557202715304D-1
     &*t29*t37*t41-0.2019022881086121D0*t111*t114*t41+0.5047557202715304
     &D-1*t32*t38*t117)+0.5047557202311499D-1*t29
      t144 = t90*t11
      t147 = GAA*t57*t62
      t169 = -0.109572371747778D1*RA*t3/PI/t87*(0.1243781095D1*(0.757133
     &5803467249D-1*(0.19887D0*t90*t17-0.2485875D-1*t71/t59/t95/t15/t14)
     &*GAA*t29+0.7571335803467249D-1*t20*t24*t28+0.1441975308641975D0*t5
     &2*t137-0.1802469135802469D0*t137*t66-0.9012345679012346D-1*t52/t66
     &*(0.225D-1*t144+0.5732512584886505D-2*t147)+0.21734463590248D-3*t1
     &47+0.13775089344D-1*t144+0.4393058205D-3*t6*t73*t76)*t83-0.2334981
     &205652682D0*t79/t82/t81*t29)
       D1F(i, ID_GAA_POS) = D1F(i, ID_GAA_POS) +      t169 
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t7 = GAA**2
      t8 = RA**2
      t10 = t7/t8
      t11 = TA**2
      t12 = 1/t11
      t13 = t10*t12
      t15 = 1.D0+0.625D-1*t13
      t16 = t15**2
      t17 = 1/t16
      t23 = t1**(1.D0/3.D0)
      t24 = t23**2
      t25 = 1/t24
      t26 = RA**(1.D0/3.D0)
      t27 = t26**2
      t29 = 1/t27/t8
      t30 = t25*t29
      t33 = GAA*t25
      t38 = 4.D0/GAA*RA*TA-1.D0
      t39 = t29*t38
      t42 = 0.1261889300577875D0*t33*t39-1.D0
      t47 = dsqrt(1.D0+0.5047557202715304D-1*t33*t39*t42)
      t48 = 1/t47
      t51 = t33*t29
      t53 = 0.45D0*t42*t48+0.5047557202311499D-1*t51
      t54 = t53**2
      t58 = 1/t23/t1
      t60 = t8**2
      t64 = t7*t58/t26/t60/RA
      t67 = dsqrt(0.1125D-1*t13+0.2866256292443252D-2*t64)
      t73 = t1**2
      t76 = t60**2
      t83 = (1.D0+0.9386624443156864D-1*t51)**2
      t84 = 1/t83
      t88 = (1.D0+0.1243781095D1*(0.7571335803467249D-1*(0.1234567901234
     &568D0+0.99435D-1*t10*t12*t17)*GAA*t30+0.7209876543209877D-1*t54-0.
     &1802469135802469D0*t53*t67+0.10867231795124D-3*t64+0.6887544672D-2
     &*t13+0.1464352735D-3*t7*GAA/t73/t76)*t84)**2
      t91 = 1/t11/TA
      t95 = t7**2
      t98 = t11**2
      t112 = t25/t27/RA
      t115 = t47**2
      t130 = 0.2271400741040175D0*t112*t48-0.225D0*t42/t115/t47*(0.20190
     &22881086121D0*t112*t42+0.2547783371264491D-1*GAA*t58/t26/t60*t38)
      t137 = t10*t91
      t146 = -0.1362840445141984D1*RA*t3/PI/t88*(0.7571335803467249D-1*(
     &-0.19887D0*t10*t91*t17+0.2485875D-1*t95/t60/t98/TA/t16/t15)*GAA*t3
     &0+0.1441975308641975D0*t53*t130-0.1802469135802469D0*t130*t67+0.20
     &27777777777778D-2*t53/t67*t137-0.13775089344D-1*t137)*t84
       D1F(i, ID_TA_POS) = D1F(i, ID_TA_POS) +      t146 
      D1F(i, ID_TB_POS)= D1F(i, ID_TA_POS)
      D1F(i, ID_GBB_POS)= D1F(i, ID_GAA_POS)
      D1F(i, ID_RB_POS)= D1F(i, ID_RA_POS)
      END DO
      RETURN
      END
                   
                   
      subroutine functional_tpssx_open
     &(INFOR,NG,TOL,rhoA,rhoB,DRhoA,DRhoB,TauA,TauB,F,D1F)
      IMPLICIT DOUBLE PRECISION (A-H,O-Z)
!--------------------------------------------------------
! This routine is used to calculate the functional and
! functional derivatives values up to the third order.
! We note that this routine is used in the open shell case.
!--------------------------------------------------------
#include "fderiv1.inc"
      INTEGER INFOR(*)
      INTEGER  D1VARS(N_FUNC_DERIV_1)
      INTEGER  ID_RA_POS, ID_GAA_POS, ID_GAB_POS, ID_TA_POS
      INTEGER  ID_RB_POS, ID_GBB_POS, ID_TB_POS
      INTEGER I, NG
      DOUBLE PRECISION rhoA(NG)
      DOUBLE PRECISION RA, RB ! rho vaule at each point
      DOUBLE PRECISION DRhoA(NG,3)
      DOUBLE PRECISION GAA, GAB, GBB ! the gamma value at each point
      DOUBLE PRECISION TauA(NG)
      DOUBLE PRECISION TA, TB     ! the tau value at each point
      DOUBLE PRECISION rhoB(NG)
      DOUBLE PRECISION DRhoB(NG,3),TauB(NG)
      DOUBLE PRECISION F(NG),D1F(NG,*)
      DOUBLE PRECISION TOL ! tolerance
      DOUBLE PRECISION PI
      
      ! firstly initilize variable position information
      CALL INIT_FUNC_DERIV_1(INFOR,D1VARS)
      ID_RA_POS  = D1VARS(ID_RA)
      ID_RB_POS  = D1VARS(ID_RB)
      ID_GAA_POS = D1VARS(ID_GAA)
      ID_GAB_POS = D1VARS(ID_GAB)
      ID_GBB_POS = D1VARS(ID_GBB)
      ID_TA_POS  = D1VARS(ID_TA)
      ID_TB_POS  = D1VARS(ID_TB)
      
      ! deal with the constants
      PI = 4.D0*DATAN(1.D0)

      ! the real calculation begins
      DO i = 1,NG
         RA = rhoA(i)
         RB = rhoB(i)
         GAA = DRhoA(i,1)*DRhoA(i,1) + DRhoA(i,2)*DRhoA(i,2)
     &+ DRhoA(i,3)*DRhoA(i,3)
         GBB = DRhoB(i,1)*DRhoB(i,1) + DRhoB(i,2)*DRhoB(i,2)
     &+ DRhoB(i,3)*DRhoB(i,3)
         GAB = DRhoA(i,1)*DRhoB(i,1) + DRhoA(i,2)*DRhoB(i,2)
     &+ DRhoA(i,3)*DRhoB(i,3)
         TA = TauA(i)
         TB = TauB(i)
         IF (RB.LE.TOL) THEN
            RB = 0.0D0 
            GBB = 0.0D0
            GAB = 0.0D0
            TB = 0.0D0
         END IF 
         IF (RA.LE.TOL) THEN
            RA = 0.0D0 
            GAA = 0.0D0
            GAB = 0.0D0
            TA = 0.0D0
         END IF 
         IF (RA.LE.TOL .AND. RB.LE.TOL) THEN
            CYCLE 
         END IF 
             
      IF (RA.GT.TOL .AND. RB.GT.TOL) THEN
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t5 = 1/PI
      t6 = GAA**2
      t7 = RA**2
      t9 = t6/t7
      t10 = TA**2
      t11 = 1/t10
      t12 = t9*t11
      t15 = (1.D0+0.625D-1*t12)**2
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RA**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t32 = GAA*t24
      t38 = t28*(4.D0/GAA*RA*TA-1.D0)
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t50 = t32*t28
      t52 = 0.45D0*t41/t46+0.5047557202311499D-1*t50
      t53 = t52**2
      t57 = 1/t22/t1
      t59 = t7**2
      t63 = t6*t57/t25/t59/RA
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t72 = t1**2
      t73 = 1/t72
      t75 = t59**2
      t82 = (1.D0+0.9386624443156864D-1*t50)**2
      t94 = (t1*RB)**(1.D0/3.D0)
      t96 = GBB**2
      t97 = RB**2
      t99 = t96/t97
      t100 = TB**2
      t101 = 1/t100
      t102 = t99*t101
      t105 = (1.D0+0.625D-1*t102)**2
      t112 = RB**(1.D0/3.D0)
      t113 = t112**2
      t115 = 1/t113/t97
      t119 = GBB*t24
      t125 = t115*(4.D0/GBB*RB*TB-1.D0)
      t128 = 0.1261889300577875D0*t119*t125-1.D0
      t133 = dsqrt(1.D0+0.5047557202715304D-1*t119*t125*t128)
      t137 = t119*t115
      t139 = 0.45D0*t128/t133+0.5047557202311499D-1*t137
      t140 = t139**2
      t144 = t97**2
      t148 = t96*t57/t112/t144/RB
      t151 = dsqrt(0.1125D-1*t102+0.2866256292443252D-2*t148)
      t158 = t144**2
      t165 = (1.D0+0.9386624443156864D-1*t137)**2
      t176 = -0.1362840444624105D1*RA*t3*t5*(0.1804D1-0.804D0/(1.D0+0.12
     &43781095D1*(0.7571335803467249D-1*(0.1234567901234568D0+0.99435D-1
     &*t9*t11/t15)*GAA*t24*t28+0.7209876543209877D-1*t53-0.1802469135802
     &469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D-2*t12+0.146435
     &2735D-3*t6*GAA*t73/t75)/t82))-0.1362840444624105D1*RB*t94*t5*(0.18
     &04D1-0.804D0/(1.D0+0.1243781095D1*(0.7571335803467249D-1*(0.123456
     &7901234568D0+0.99435D-1*t99*t101/t105)*GBB*t24*t115+0.720987654320
     &9877D-1*t140-0.1802469135802469D0*t139*t151+0.10867231795124D-3*t1
     &48+0.6887544672D-2*t102+0.1464352735D-3*t96*GBB*t73/t158)/t165))
       F(i) = F(i) +      t176 

      ! deriv
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t4 = 1/PI
      t6 = GAA**2
      t7 = RA**2
      t9 = t6/t7
      t10 = TA**2
      t11 = 1/t10
      t12 = t9*t11
      t14 = 1.D0+0.625D-1*t12
      t15 = t14**2
      t17 = t11/t15
      t21 = (0.1234567901234568D0+0.99435D-1*t9*t17)*GAA
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RA**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t29 = t24*t28
      t32 = GAA*t24
      t37 = 4.D0/GAA*RA*TA-1.D0
      t38 = t28*t37
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t47 = 1/t46
      t50 = t32*t28
      t52 = 0.45D0*t41*t47+0.5047557202311499D-1*t50
      t53 = t52**2
      t58 = t6/t22/t1
      t59 = t7**2
      t60 = t59*RA
      t63 = t58/t25/t60
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t72 = t1**2
      t74 = t6*GAA/t72
      t75 = t59**2
      t79 = 0.7571335803467249D-1*t21*t29+0.7209876543209877D-1*t53-0.18
     &02469135802469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D-2*t
     &12+0.1464352735D-3*t74/t75
      t81 = 1.D0+0.9386624443156864D-1*t50
      t82 = t81**2
      t83 = 1/t82
      t86 = 1.D0+0.1243781095D1*t79*t83
      t89 = 0.1804D1-0.804D0/t86
      t92 = t3**2
      t99 = t86**2
      t102 = t7*RA
      t104 = t6/t102
      t107 = t6**2
      t110 = t10**2
      t122 = 1/t26/t102
      t126 = t122*t37
      t131 = -0.3365038134874333D0*t32*t126+0.5047557202311499D0*t29*TA
      t134 = t46**2
      t150 = t32*t122
      t152 = 0.45D0*t131*t47-0.225D0*t41/t134/t46*(-0.1346015254057414D0
     &*t32*t126*t41+0.2019022881086121D0*t29*TA*t41+0.5047557202715304D-
     &1*t32*t38*t131)-0.1346015253949733D0*t150
      t159 = t104*t11
      t164 = t58/t25/t59/t7
      t187 = -0.1362840444624105D1*t3*t4*t89-0.4542801482080349D0*RA/t92
     &*PI*t89-0.109572371747778D1*RA*t3*t4/t99*(0.1243781095D1*(0.757133
     &5803467249D-1*(-0.19887D0*t104*t17+0.2485875D-1*t107/t60/t110/t15/
     &t14)*GAA*t29-0.20190228809246D0*t21*t24*t122+0.1441975308641975D0*
     &t52*t152-0.1802469135802469D0*t152*t66-0.9012345679012346D-1*t52/t
     &66*(-0.225D-1*t159-0.1528670022636401D-1*t164)-0.5795856957399467D
     &-3*t164-0.13775089344D-1*t159-0.1171482188D-2*t74/t75/RA)*t83+0.62
     &26616548407152D0*t79/t82/t81*t150)
       D1F(i, ID_RA_POS) = D1F(i, ID_RA_POS) +      t187 
      t1 = PI**2
      t3 = (t1*RB)**(1.D0/3.D0)
      t4 = 1/PI
      t6 = GBB**2
      t7 = RB**2
      t9 = t6/t7
      t10 = TB**2
      t11 = 1/t10
      t12 = t9*t11
      t14 = 1.D0+0.625D-1*t12
      t15 = t14**2
      t17 = t11/t15
      t21 = (0.1234567901234568D0+0.99435D-1*t9*t17)*GBB
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RB**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t29 = t24*t28
      t32 = GBB*t24
      t37 = 4.D0/GBB*RB*TB-1.D0
      t38 = t28*t37
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t47 = 1/t46
      t50 = t32*t28
      t52 = 0.45D0*t41*t47+0.5047557202311499D-1*t50
      t53 = t52**2
      t58 = t6/t22/t1
      t59 = t7**2
      t60 = t59*RB
      t63 = t58/t25/t60
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t72 = t1**2
      t74 = t6*GBB/t72
      t75 = t59**2
      t79 = 0.7571335803467249D-1*t21*t29+0.7209876543209877D-1*t53-0.18
     &02469135802469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D-2*t
     &12+0.1464352735D-3*t74/t75
      t81 = 1.D0+0.9386624443156864D-1*t50
      t82 = t81**2
      t83 = 1/t82
      t86 = 1.D0+0.1243781095D1*t79*t83
      t89 = 0.1804D1-0.804D0/t86
      t92 = t3**2
      t99 = t86**2
      t102 = t7*RB
      t104 = t6/t102
      t107 = t6**2
      t110 = t10**2
      t122 = 1/t26/t102
      t126 = t122*t37
      t131 = -0.3365038134874333D0*t32*t126+0.5047557202311499D0*t29*TB
      t134 = t46**2
      t150 = t32*t122
      t152 = 0.45D0*t131*t47-0.225D0*t41/t134/t46*(-0.1346015254057414D0
     &*t32*t126*t41+0.2019022881086121D0*t29*TB*t41+0.5047557202715304D-
     &1*t32*t38*t131)-0.1346015253949733D0*t150
      t159 = t104*t11
      t164 = t58/t25/t59/t7
      t187 = -0.1362840444624105D1*t3*t4*t89-0.4542801482080349D0*RB/t92
     &*PI*t89-0.109572371747778D1*RB*t3*t4/t99*(0.1243781095D1*(0.757133
     &5803467249D-1*(-0.19887D0*t104*t17+0.2485875D-1*t107/t60/t110/t15/
     &t14)*GBB*t29-0.20190228809246D0*t21*t24*t122+0.1441975308641975D0*
     &t52*t152-0.1802469135802469D0*t152*t66-0.9012345679012346D-1*t52/t
     &66*(-0.225D-1*t159-0.1528670022636401D-1*t164)-0.5795856957399467D
     &-3*t164-0.13775089344D-1*t159-0.1171482188D-2*t74/t75/RB)*t83+0.62
     &26616548407152D0*t79/t82/t81*t150)
       D1F(i, ID_RB_POS) = D1F(i, ID_RB_POS) +      t187 
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t6 = GAA**2
      t7 = RA**2
      t8 = 1/t7
      t9 = t6*t8
      t10 = TA**2
      t11 = 1/t10
      t12 = t9*t11
      t14 = 1.D0+0.625D-1*t12
      t15 = t14**2
      t17 = t11/t15
      t20 = 0.1234567901234568D0+0.99435D-1*t9*t17
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RA**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t29 = t24*t28
      t32 = GAA*t24
      t33 = 1/GAA
      t37 = 4.D0*t33*RA*TA-1.D0
      t38 = t28*t37
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t47 = 1/t46
      t50 = t32*t28
      t52 = 0.45D0*t41*t47+0.5047557202311499D-1*t50
      t53 = t52**2
      t57 = 1/t22/t1
      t59 = t7**2
      t62 = 1/t25/t59/RA
      t63 = t6*t57*t62
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t71 = t6*GAA
      t72 = t1**2
      t73 = 1/t72
      t75 = t59**2
      t76 = 1/t75
      t79 = 0.7571335803467249D-1*t20*GAA*t29+0.7209876543209877D-1*t53-
     &0.1802469135802469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D
     &-2*t12+0.1464352735D-3*t71*t73*t76
      t81 = 1.D0+0.9386624443156864D-1*t50
      t82 = t81**2
      t83 = 1/t82
      t87 = (1.D0+0.1243781095D1*t79*t83)**2
      t90 = GAA*t8
      t95 = t10**2
      t111 = t33*t24
      t114 = 1/t26/RA*TA
      t117 = 0.1261889300577875D0*t29*t37-0.5047557202311499D0*t111*t114
      t120 = t46**2
      t137 = 0.45D0*t117*t47-0.225D0*t41/t120/t46*(0.5047557202715304D-1
     &*t29*t37*t41-0.2019022881086121D0*t111*t114*t41+0.5047557202715304
     &D-1*t32*t38*t117)+0.5047557202311499D-1*t29
      t144 = t90*t11
      t147 = GAA*t57*t62
      t169 = -0.109572371747778D1*RA*t3/PI/t87*(0.1243781095D1*(0.757133
     &5803467249D-1*(0.19887D0*t90*t17-0.2485875D-1*t71/t59/t95/t15/t14)
     &*GAA*t29+0.7571335803467249D-1*t20*t24*t28+0.1441975308641975D0*t5
     &2*t137-0.1802469135802469D0*t137*t66-0.9012345679012346D-1*t52/t66
     &*(0.225D-1*t144+0.5732512584886505D-2*t147)+0.21734463590248D-3*t1
     &47+0.13775089344D-1*t144+0.4393058205D-3*t6*t73*t76)*t83-0.2334981
     &205652682D0*t79/t82/t81*t29)
       D1F(i, ID_GAA_POS) = D1F(i, ID_GAA_POS) +      t169 
      t1 = PI**2
      t3 = (t1*RB)**(1.D0/3.D0)
      t6 = GBB**2
      t7 = RB**2
      t8 = 1/t7
      t9 = t6*t8
      t10 = TB**2
      t11 = 1/t10
      t12 = t9*t11
      t14 = 1.D0+0.625D-1*t12
      t15 = t14**2
      t17 = t11/t15
      t20 = 0.1234567901234568D0+0.99435D-1*t9*t17
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RB**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t29 = t24*t28
      t32 = GBB*t24
      t33 = 1/GBB
      t37 = 4.D0*t33*RB*TB-1.D0
      t38 = t28*t37
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t47 = 1/t46
      t50 = t32*t28
      t52 = 0.45D0*t41*t47+0.5047557202311499D-1*t50
      t53 = t52**2
      t57 = 1/t22/t1
      t59 = t7**2
      t62 = 1/t25/t59/RB
      t63 = t6*t57*t62
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t71 = t6*GBB
      t72 = t1**2
      t73 = 1/t72
      t75 = t59**2
      t76 = 1/t75
      t79 = 0.7571335803467249D-1*t20*GBB*t29+0.7209876543209877D-1*t53-
     &0.1802469135802469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D
     &-2*t12+0.1464352735D-3*t71*t73*t76
      t81 = 1.D0+0.9386624443156864D-1*t50
      t82 = t81**2
      t83 = 1/t82
      t87 = (1.D0+0.1243781095D1*t79*t83)**2
      t90 = GBB*t8
      t95 = t10**2
      t111 = t33*t24
      t114 = 1/t26/RB*TB
      t117 = 0.1261889300577875D0*t29*t37-0.5047557202311499D0*t111*t114
      t120 = t46**2
      t137 = 0.45D0*t117*t47-0.225D0*t41/t120/t46*(0.5047557202715304D-1
     &*t29*t37*t41-0.2019022881086121D0*t111*t114*t41+0.5047557202715304
     &D-1*t32*t38*t117)+0.5047557202311499D-1*t29
      t144 = t90*t11
      t147 = GBB*t57*t62
      t169 = -0.109572371747778D1*RB*t3/PI/t87*(0.1243781095D1*(0.757133
     &5803467249D-1*(0.19887D0*t90*t17-0.2485875D-1*t71/t59/t95/t15/t14)
     &*GBB*t29+0.7571335803467249D-1*t20*t24*t28+0.1441975308641975D0*t5
     &2*t137-0.1802469135802469D0*t137*t66-0.9012345679012346D-1*t52/t66
     &*(0.225D-1*t144+0.5732512584886505D-2*t147)+0.21734463590248D-3*t1
     &47+0.13775089344D-1*t144+0.4393058205D-3*t6*t73*t76)*t83-0.2334981
     &205652682D0*t79/t82/t81*t29)
       D1F(i, ID_GBB_POS) = D1F(i, ID_GBB_POS) +      t169 
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t7 = GAA**2
      t8 = RA**2
      t10 = t7/t8
      t11 = TA**2
      t12 = 1/t11
      t13 = t10*t12
      t15 = 1.D0+0.625D-1*t13
      t16 = t15**2
      t17 = 1/t16
      t23 = t1**(1.D0/3.D0)
      t24 = t23**2
      t25 = 1/t24
      t26 = RA**(1.D0/3.D0)
      t27 = t26**2
      t29 = 1/t27/t8
      t30 = t25*t29
      t33 = GAA*t25
      t38 = 4.D0/GAA*RA*TA-1.D0
      t39 = t29*t38
      t42 = 0.1261889300577875D0*t33*t39-1.D0
      t47 = dsqrt(1.D0+0.5047557202715304D-1*t33*t39*t42)
      t48 = 1/t47
      t51 = t33*t29
      t53 = 0.45D0*t42*t48+0.5047557202311499D-1*t51
      t54 = t53**2
      t58 = 1/t23/t1
      t60 = t8**2
      t64 = t7*t58/t26/t60/RA
      t67 = dsqrt(0.1125D-1*t13+0.2866256292443252D-2*t64)
      t73 = t1**2
      t76 = t60**2
      t83 = (1.D0+0.9386624443156864D-1*t51)**2
      t84 = 1/t83
      t88 = (1.D0+0.1243781095D1*(0.7571335803467249D-1*(0.1234567901234
     &568D0+0.99435D-1*t10*t12*t17)*GAA*t30+0.7209876543209877D-1*t54-0.
     &1802469135802469D0*t53*t67+0.10867231795124D-3*t64+0.6887544672D-2
     &*t13+0.1464352735D-3*t7*GAA/t73/t76)*t84)**2
      t91 = 1/t11/TA
      t95 = t7**2
      t98 = t11**2
      t112 = t25/t27/RA
      t115 = t47**2
      t130 = 0.2271400741040175D0*t112*t48-0.225D0*t42/t115/t47*(0.20190
     &22881086121D0*t112*t42+0.2547783371264491D-1*GAA*t58/t26/t60*t38)
      t137 = t10*t91
      t146 = -0.1362840445141984D1*RA*t3/PI/t88*(0.7571335803467249D-1*(
     &-0.19887D0*t10*t91*t17+0.2485875D-1*t95/t60/t98/TA/t16/t15)*GAA*t3
     &0+0.1441975308641975D0*t53*t130-0.1802469135802469D0*t130*t67+0.20
     &27777777777778D-2*t53/t67*t137-0.13775089344D-1*t137)*t84
       D1F(i, ID_TA_POS) = D1F(i, ID_TA_POS) +      t146 
      t1 = PI**2
      t3 = (t1*RB)**(1.D0/3.D0)
      t7 = GBB**2
      t8 = RB**2
      t10 = t7/t8
      t11 = TB**2
      t12 = 1/t11
      t13 = t10*t12
      t15 = 1.D0+0.625D-1*t13
      t16 = t15**2
      t17 = 1/t16
      t23 = t1**(1.D0/3.D0)
      t24 = t23**2
      t25 = 1/t24
      t26 = RB**(1.D0/3.D0)
      t27 = t26**2
      t29 = 1/t27/t8
      t30 = t25*t29
      t33 = GBB*t25
      t38 = 4.D0/GBB*RB*TB-1.D0
      t39 = t29*t38
      t42 = 0.1261889300577875D0*t33*t39-1.D0
      t47 = dsqrt(1.D0+0.5047557202715304D-1*t33*t39*t42)
      t48 = 1/t47
      t51 = t33*t29
      t53 = 0.45D0*t42*t48+0.5047557202311499D-1*t51
      t54 = t53**2
      t58 = 1/t23/t1
      t60 = t8**2
      t64 = t7*t58/t26/t60/RB
      t67 = dsqrt(0.1125D-1*t13+0.2866256292443252D-2*t64)
      t73 = t1**2
      t76 = t60**2
      t83 = (1.D0+0.9386624443156864D-1*t51)**2
      t84 = 1/t83
      t88 = (1.D0+0.1243781095D1*(0.7571335803467249D-1*(0.1234567901234
     &568D0+0.99435D-1*t10*t12*t17)*GBB*t30+0.7209876543209877D-1*t54-0.
     &1802469135802469D0*t53*t67+0.10867231795124D-3*t64+0.6887544672D-2
     &*t13+0.1464352735D-3*t7*GBB/t73/t76)*t84)**2
      t91 = 1/t11/TB
      t95 = t7**2
      t98 = t11**2
      t112 = t25/t27/RB
      t115 = t47**2
      t130 = 0.2271400741040175D0*t112*t48-0.225D0*t42/t115/t47*(0.20190
     &22881086121D0*t112*t42+0.2547783371264491D-1*GBB*t58/t26/t60*t38)
      t137 = t10*t91
      t146 = -0.1362840445141984D1*RB*t3/PI/t88*(0.7571335803467249D-1*(
     &-0.19887D0*t10*t91*t17+0.2485875D-1*t95/t60/t98/TB/t16/t15)*GBB*t3
     &0+0.1441975308641975D0*t53*t130-0.1802469135802469D0*t130*t67+0.20
     &27777777777778D-2*t53/t67*t137-0.13775089344D-1*t137)*t84
       D1F(i, ID_TB_POS) = D1F(i, ID_TB_POS) +      t146 
       
      ELSE IF (RA.GT.TOL .AND. RB.LE.TOL) THEN
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t6 = GAA**2
      t7 = RA**2
      t9 = t6/t7
      t10 = TA**2
      t11 = 1/t10
      t12 = t9*t11
      t15 = (1.D0+0.625D-1*t12)**2
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RA**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t32 = GAA*t24
      t38 = t28*(4.D0/GAA*RA*TA-1.D0)
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t50 = t32*t28
      t52 = 0.45D0*t41/t46+0.5047557202311499D-1*t50
      t53 = t52**2
      t59 = t7**2
      t63 = t6/t22/t1/t25/t59/RA
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t72 = t1**2
      t75 = t59**2
      t82 = (1.D0+0.9386624443156864D-1*t50)**2
      t93 = -0.1362840444624105D1*RA*t3/PI*(0.1804D1-0.804D0/(1.D0+0.124
     &3781095D1*(0.7571335803467249D-1*(0.1234567901234568D0+0.99435D-1*
     &t9*t11/t15)*GAA*t24*t28+0.7209876543209877D-1*t53-0.18024691358024
     &69D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D-2*t12+0.1464352
     &735D-3*t6*GAA/t72/t75)/t82))
       F(i) = F(i) +      t93 

      ! deriv 
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t4 = 1/PI
      t6 = GAA**2
      t7 = RA**2
      t9 = t6/t7
      t10 = TA**2
      t11 = 1/t10
      t12 = t9*t11
      t14 = 1.D0+0.625D-1*t12
      t15 = t14**2
      t17 = t11/t15
      t21 = (0.1234567901234568D0+0.99435D-1*t9*t17)*GAA
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RA**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t29 = t24*t28
      t32 = GAA*t24
      t37 = 4.D0/GAA*RA*TA-1.D0
      t38 = t28*t37
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t47 = 1/t46
      t50 = t32*t28
      t52 = 0.45D0*t41*t47+0.5047557202311499D-1*t50
      t53 = t52**2
      t58 = t6/t22/t1
      t59 = t7**2
      t60 = t59*RA
      t63 = t58/t25/t60
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t72 = t1**2
      t74 = t6*GAA/t72
      t75 = t59**2
      t79 = 0.7571335803467249D-1*t21*t29+0.7209876543209877D-1*t53-0.18
     &02469135802469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D-2*t
     &12+0.1464352735D-3*t74/t75
      t81 = 1.D0+0.9386624443156864D-1*t50
      t82 = t81**2
      t83 = 1/t82
      t86 = 1.D0+0.1243781095D1*t79*t83
      t89 = 0.1804D1-0.804D0/t86
      t92 = t3**2
      t99 = t86**2
      t102 = t7*RA
      t104 = t6/t102
      t107 = t6**2
      t110 = t10**2
      t122 = 1/t26/t102
      t126 = t122*t37
      t131 = -0.3365038134874333D0*t32*t126+0.5047557202311499D0*t29*TA
      t134 = t46**2
      t150 = t32*t122
      t152 = 0.45D0*t131*t47-0.225D0*t41/t134/t46*(-0.1346015254057414D0
     &*t32*t126*t41+0.2019022881086121D0*t29*TA*t41+0.5047557202715304D-
     &1*t32*t38*t131)-0.1346015253949733D0*t150
      t159 = t104*t11
      t164 = t58/t25/t59/t7
      t187 = -0.1362840444624105D1*t3*t4*t89-0.4542801482080349D0*RA/t92
     &*PI*t89-0.109572371747778D1*RA*t3*t4/t99*(0.1243781095D1*(0.757133
     &5803467249D-1*(-0.19887D0*t104*t17+0.2485875D-1*t107/t60/t110/t15/
     &t14)*GAA*t29-0.20190228809246D0*t21*t24*t122+0.1441975308641975D0*
     &t52*t152-0.1802469135802469D0*t152*t66-0.9012345679012346D-1*t52/t
     &66*(-0.225D-1*t159-0.1528670022636401D-1*t164)-0.5795856957399467D
     &-3*t164-0.13775089344D-1*t159-0.1171482188D-2*t74/t75/RA)*t83+0.62
     &26616548407152D0*t79/t82/t81*t150)
       D1F(i, ID_RA_POS) = D1F(i, ID_RA_POS) +      t187 
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t6 = GAA**2
      t7 = RA**2
      t8 = 1/t7
      t9 = t6*t8
      t10 = TA**2
      t11 = 1/t10
      t12 = t9*t11
      t14 = 1.D0+0.625D-1*t12
      t15 = t14**2
      t17 = t11/t15
      t20 = 0.1234567901234568D0+0.99435D-1*t9*t17
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RA**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t29 = t24*t28
      t32 = GAA*t24
      t33 = 1/GAA
      t37 = 4.D0*t33*RA*TA-1.D0
      t38 = t28*t37
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t47 = 1/t46
      t50 = t32*t28
      t52 = 0.45D0*t41*t47+0.5047557202311499D-1*t50
      t53 = t52**2
      t57 = 1/t22/t1
      t59 = t7**2
      t62 = 1/t25/t59/RA
      t63 = t6*t57*t62
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t71 = t6*GAA
      t72 = t1**2
      t73 = 1/t72
      t75 = t59**2
      t76 = 1/t75
      t79 = 0.7571335803467249D-1*t20*GAA*t29+0.7209876543209877D-1*t53-
     &0.1802469135802469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D
     &-2*t12+0.1464352735D-3*t71*t73*t76
      t81 = 1.D0+0.9386624443156864D-1*t50
      t82 = t81**2
      t83 = 1/t82
      t87 = (1.D0+0.1243781095D1*t79*t83)**2
      t90 = GAA*t8
      t95 = t10**2
      t111 = t33*t24
      t114 = 1/t26/RA*TA
      t117 = 0.1261889300577875D0*t29*t37-0.5047557202311499D0*t111*t114
      t120 = t46**2
      t137 = 0.45D0*t117*t47-0.225D0*t41/t120/t46*(0.5047557202715304D-1
     &*t29*t37*t41-0.2019022881086121D0*t111*t114*t41+0.5047557202715304
     &D-1*t32*t38*t117)+0.5047557202311499D-1*t29
      t144 = t90*t11
      t147 = GAA*t57*t62
      t169 = -0.109572371747778D1*RA*t3/PI/t87*(0.1243781095D1*(0.757133
     &5803467249D-1*(0.19887D0*t90*t17-0.2485875D-1*t71/t59/t95/t15/t14)
     &*GAA*t29+0.7571335803467249D-1*t20*t24*t28+0.1441975308641975D0*t5
     &2*t137-0.1802469135802469D0*t137*t66-0.9012345679012346D-1*t52/t66
     &*(0.225D-1*t144+0.5732512584886505D-2*t147)+0.21734463590248D-3*t1
     &47+0.13775089344D-1*t144+0.4393058205D-3*t6*t73*t76)*t83-0.2334981
     &205652682D0*t79/t82/t81*t29)
       D1F(i, ID_GAA_POS) = D1F(i, ID_GAA_POS) +      t169 
      t1 = PI**2
      t3 = (t1*RA)**(1.D0/3.D0)
      t7 = GAA**2
      t8 = RA**2
      t10 = t7/t8
      t11 = TA**2
      t12 = 1/t11
      t13 = t10*t12
      t15 = 1.D0+0.625D-1*t13
      t16 = t15**2
      t17 = 1/t16
      t23 = t1**(1.D0/3.D0)
      t24 = t23**2
      t25 = 1/t24
      t26 = RA**(1.D0/3.D0)
      t27 = t26**2
      t29 = 1/t27/t8
      t30 = t25*t29
      t33 = GAA*t25
      t38 = 4.D0/GAA*RA*TA-1.D0
      t39 = t29*t38
      t42 = 0.1261889300577875D0*t33*t39-1.D0
      t47 = dsqrt(1.D0+0.5047557202715304D-1*t33*t39*t42)
      t48 = 1/t47
      t51 = t33*t29
      t53 = 0.45D0*t42*t48+0.5047557202311499D-1*t51
      t54 = t53**2
      t58 = 1/t23/t1
      t60 = t8**2
      t64 = t7*t58/t26/t60/RA
      t67 = dsqrt(0.1125D-1*t13+0.2866256292443252D-2*t64)
      t73 = t1**2
      t76 = t60**2
      t83 = (1.D0+0.9386624443156864D-1*t51)**2
      t84 = 1/t83
      t88 = (1.D0+0.1243781095D1*(0.7571335803467249D-1*(0.1234567901234
     &568D0+0.99435D-1*t10*t12*t17)*GAA*t30+0.7209876543209877D-1*t54-0.
     &1802469135802469D0*t53*t67+0.10867231795124D-3*t64+0.6887544672D-2
     &*t13+0.1464352735D-3*t7*GAA/t73/t76)*t84)**2
      t91 = 1/t11/TA
      t95 = t7**2
      t98 = t11**2
      t112 = t25/t27/RA
      t115 = t47**2
      t130 = 0.2271400741040175D0*t112*t48-0.225D0*t42/t115/t47*(0.20190
     &22881086121D0*t112*t42+0.2547783371264491D-1*GAA*t58/t26/t60*t38)
      t137 = t10*t91
      t146 = -0.1362840445141984D1*RA*t3/PI/t88*(0.7571335803467249D-1*(
     &-0.19887D0*t10*t91*t17+0.2485875D-1*t95/t60/t98/TA/t16/t15)*GAA*t3
     &0+0.1441975308641975D0*t53*t130-0.1802469135802469D0*t130*t67+0.20
     &27777777777778D-2*t53/t67*t137-0.13775089344D-1*t137)*t84
       D1F(i, ID_TA_POS) = D1F(i, ID_TA_POS) +      t146 

      ELSE IF (RA.LE.TOL .AND. RB.GT.TOL) THEN
      t1 = PI**2
      t3 = (t1*RB)**(1.D0/3.D0)
      t6 = GBB**2
      t7 = RB**2
      t9 = t6/t7
      t10 = TB**2
      t11 = 1/t10
      t12 = t9*t11
      t15 = (1.D0+0.625D-1*t12)**2
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RB**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t32 = GBB*t24
      t38 = t28*(4.D0/GBB*RB*TB-1.D0)
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t50 = t32*t28
      t52 = 0.45D0*t41/t46+0.5047557202311499D-1*t50
      t53 = t52**2
      t59 = t7**2
      t63 = t6/t22/t1/t25/t59/RB
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t72 = t1**2
      t75 = t59**2
      t82 = (1.D0+0.9386624443156864D-1*t50)**2
      t93 = -0.1362840444624105D1*RB*t3/PI*(0.1804D1-0.804D0/(1.D0+0.124
     &3781095D1*(0.7571335803467249D-1*(0.1234567901234568D0+0.99435D-1*
     &t9*t11/t15)*GBB*t24*t28+0.7209876543209877D-1*t53-0.18024691358024
     &69D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D-2*t12+0.1464352
     &735D-3*t6*GBB/t72/t75)/t82))
       F(i) = F(i) +      t93 

      ! deriv
      t1 = PI**2
      t3 = (t1*RB)**(1.D0/3.D0)
      t4 = 1/PI
      t6 = GBB**2
      t7 = RB**2
      t9 = t6/t7
      t10 = TB**2
      t11 = 1/t10
      t12 = t9*t11
      t14 = 1.D0+0.625D-1*t12
      t15 = t14**2
      t17 = t11/t15
      t21 = (0.1234567901234568D0+0.99435D-1*t9*t17)*GBB
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RB**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t29 = t24*t28
      t32 = GBB*t24
      t37 = 4.D0/GBB*RB*TB-1.D0
      t38 = t28*t37
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t47 = 1/t46
      t50 = t32*t28
      t52 = 0.45D0*t41*t47+0.5047557202311499D-1*t50
      t53 = t52**2
      t58 = t6/t22/t1
      t59 = t7**2
      t60 = t59*RB
      t63 = t58/t25/t60
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t72 = t1**2
      t74 = t6*GBB/t72
      t75 = t59**2
      t79 = 0.7571335803467249D-1*t21*t29+0.7209876543209877D-1*t53-0.18
     &02469135802469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D-2*t
     &12+0.1464352735D-3*t74/t75
      t81 = 1.D0+0.9386624443156864D-1*t50
      t82 = t81**2
      t83 = 1/t82
      t86 = 1.D0+0.1243781095D1*t79*t83
      t89 = 0.1804D1-0.804D0/t86
      t92 = t3**2
      t99 = t86**2
      t102 = t7*RB
      t104 = t6/t102
      t107 = t6**2
      t110 = t10**2
      t122 = 1/t26/t102
      t126 = t122*t37
      t131 = -0.3365038134874333D0*t32*t126+0.5047557202311499D0*t29*TB
      t134 = t46**2
      t150 = t32*t122
      t152 = 0.45D0*t131*t47-0.225D0*t41/t134/t46*(-0.1346015254057414D0
     &*t32*t126*t41+0.2019022881086121D0*t29*TB*t41+0.5047557202715304D-
     &1*t32*t38*t131)-0.1346015253949733D0*t150
      t159 = t104*t11
      t164 = t58/t25/t59/t7
      t187 = -0.1362840444624105D1*t3*t4*t89-0.4542801482080349D0*RB/t92
     &*PI*t89-0.109572371747778D1*RB*t3*t4/t99*(0.1243781095D1*(0.757133
     &5803467249D-1*(-0.19887D0*t104*t17+0.2485875D-1*t107/t60/t110/t15/
     &t14)*GBB*t29-0.20190228809246D0*t21*t24*t122+0.1441975308641975D0*
     &t52*t152-0.1802469135802469D0*t152*t66-0.9012345679012346D-1*t52/t
     &66*(-0.225D-1*t159-0.1528670022636401D-1*t164)-0.5795856957399467D
     &-3*t164-0.13775089344D-1*t159-0.1171482188D-2*t74/t75/RB)*t83+0.62
     &26616548407152D0*t79/t82/t81*t150)
       D1F(i, ID_RB_POS) = D1F(i, ID_RB_POS) +      t187 
      t1 = PI**2
      t3 = (t1*RB)**(1.D0/3.D0)
      t6 = GBB**2
      t7 = RB**2
      t8 = 1/t7
      t9 = t6*t8
      t10 = TB**2
      t11 = 1/t10
      t12 = t9*t11
      t14 = 1.D0+0.625D-1*t12
      t15 = t14**2
      t17 = t11/t15
      t20 = 0.1234567901234568D0+0.99435D-1*t9*t17
      t22 = t1**(1.D0/3.D0)
      t23 = t22**2
      t24 = 1/t23
      t25 = RB**(1.D0/3.D0)
      t26 = t25**2
      t28 = 1/t26/t7
      t29 = t24*t28
      t32 = GBB*t24
      t33 = 1/GBB
      t37 = 4.D0*t33*RB*TB-1.D0
      t38 = t28*t37
      t41 = 0.1261889300577875D0*t32*t38-1.D0
      t46 = dsqrt(1.D0+0.5047557202715304D-1*t32*t38*t41)
      t47 = 1/t46
      t50 = t32*t28
      t52 = 0.45D0*t41*t47+0.5047557202311499D-1*t50
      t53 = t52**2
      t57 = 1/t22/t1
      t59 = t7**2
      t62 = 1/t25/t59/RB
      t63 = t6*t57*t62
      t66 = dsqrt(0.1125D-1*t12+0.2866256292443252D-2*t63)
      t71 = t6*GBB
      t72 = t1**2
      t73 = 1/t72
      t75 = t59**2
      t76 = 1/t75
      t79 = 0.7571335803467249D-1*t20*GBB*t29+0.7209876543209877D-1*t53-
     &0.1802469135802469D0*t52*t66+0.10867231795124D-3*t63+0.6887544672D
     &-2*t12+0.1464352735D-3*t71*t73*t76
      t81 = 1.D0+0.9386624443156864D-1*t50
      t82 = t81**2
      t83 = 1/t82
      t87 = (1.D0+0.1243781095D1*t79*t83)**2
      t90 = GBB*t8
      t95 = t10**2
      t111 = t33*t24
      t114 = 1/t26/RB*TB
      t117 = 0.1261889300577875D0*t29*t37-0.5047557202311499D0*t111*t114
      t120 = t46**2
      t137 = 0.45D0*t117*t47-0.225D0*t41/t120/t46*(0.5047557202715304D-1
     &*t29*t37*t41-0.2019022881086121D0*t111*t114*t41+0.5047557202715304
     &D-1*t32*t38*t117)+0.5047557202311499D-1*t29
      t144 = t90*t11
      t147 = GBB*t57*t62
      t169 = -0.109572371747778D1*RB*t3/PI/t87*(0.1243781095D1*(0.757133
     &5803467249D-1*(0.19887D0*t90*t17-0.2485875D-1*t71/t59/t95/t15/t14)
     &*GBB*t29+0.7571335803467249D-1*t20*t24*t28+0.1441975308641975D0*t5
     &2*t137-0.1802469135802469D0*t137*t66-0.9012345679012346D-1*t52/t66
     &*(0.225D-1*t144+0.5732512584886505D-2*t147)+0.21734463590248D-3*t1
     &47+0.13775089344D-1*t144+0.4393058205D-3*t6*t73*t76)*t83-0.2334981
     &205652682D0*t79/t82/t81*t29)
       D1F(i, ID_GBB_POS) = D1F(i, ID_GBB_POS) +      t169 
      t1 = PI**2
      t3 = (t1*RB)**(1.D0/3.D0)
      t7 = GBB**2
      t8 = RB**2
      t10 = t7/t8
      t11 = TB**2
      t12 = 1/t11
      t13 = t10*t12
      t15 = 1.D0+0.625D-1*t13
      t16 = t15**2
      t17 = 1/t16
      t23 = t1**(1.D0/3.D0)
      t24 = t23**2
      t25 = 1/t24
      t26 = RB**(1.D0/3.D0)
      t27 = t26**2
      t29 = 1/t27/t8
      t30 = t25*t29
      t33 = GBB*t25
      t38 = 4.D0/GBB*RB*TB-1.D0
      t39 = t29*t38
      t42 = 0.1261889300577875D0*t33*t39-1.D0
      t47 = dsqrt(1.D0+0.5047557202715304D-1*t33*t39*t42)
      t48 = 1/t47
      t51 = t33*t29
      t53 = 0.45D0*t42*t48+0.5047557202311499D-1*t51
      t54 = t53**2
      t58 = 1/t23/t1
      t60 = t8**2
      t64 = t7*t58/t26/t60/RB
      t67 = dsqrt(0.1125D-1*t13+0.2866256292443252D-2*t64)
      t73 = t1**2
      t76 = t60**2
      t83 = (1.D0+0.9386624443156864D-1*t51)**2
      t84 = 1/t83
      t88 = (1.D0+0.1243781095D1*(0.7571335803467249D-1*(0.1234567901234
     &568D0+0.99435D-1*t10*t12*t17)*GBB*t30+0.7209876543209877D-1*t54-0.
     &1802469135802469D0*t53*t67+0.10867231795124D-3*t64+0.6887544672D-2
     &*t13+0.1464352735D-3*t7*GBB/t73/t76)*t84)**2
      t91 = 1/t11/TB
      t95 = t7**2
      t98 = t11**2
      t112 = t25/t27/RB
      t115 = t47**2
      t130 = 0.2271400741040175D0*t112*t48-0.225D0*t42/t115/t47*(0.20190
     &22881086121D0*t112*t42+0.2547783371264491D-1*GBB*t58/t26/t60*t38)
      t137 = t10*t91
      t146 = -0.1362840445141984D1*RB*t3/PI/t88*(0.7571335803467249D-1*(
     &-0.19887D0*t10*t91*t17+0.2485875D-1*t95/t60/t98/TB/t16/t15)*GBB*t3
     &0+0.1441975308641975D0*t53*t130-0.1802469135802469D0*t130*t67+0.20
     &27777777777778D-2*t53/t67*t137-0.13775089344D-1*t137)*t84
       D1F(i, ID_TB_POS) =      t146 
      END IF
      END DO
      RETURN
      END
                   
                   
                   
                   
